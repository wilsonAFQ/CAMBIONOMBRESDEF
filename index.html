<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Renombrador de Imágenes Avanzado</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --error: #f72585;
            --warning: #ff9e00;
            --light: #f8f9fa;
            --dark: #212529;
        }
        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            background: #f5f7ff;
            padding: 1rem;
            margin: 0;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            padding: 2rem;
        }
        h1 {
            color: var(--primary);
            text-align: center;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
        }
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }
        .btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-secondary {
            background: var(--light);
            color: var(--dark);
            border: 1px solid #ddd;
        }
        .btn-secondary:hover {
            background: #e9ecef;
            color: var(--dark);
        }
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        .btn-warning:hover {
            background: #e69100;
        }
        .step {
            display: none;
            padding: 1.5rem;
            border: 1px solid #eee;
            border-radius: 8px;
            margin: 1rem 0;
            background: #fff;
        }
        .step.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        #fileList {
            max-height: 300px;
            overflow-y: auto;
            margin: 1rem 0;
            border: 1px solid #ddd;
            padding: 1rem;
            border-radius: 5px;
            background: #fafafa;
        }
        .file-item {
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        .file-item:hover {
            background: #f0f4ff;
        }
        .file-item .file-path {
            flex: 1;
            font-family: monospace;
            font-size: 0.9rem;
            color: #555;
            word-break: break-all;
        }
        .file-item .file-size {
            color: #777;
            font-size: 0.8rem;
            margin-left: 1rem;
        }
        .progress-container {
            margin: 1.5rem 0;
        }
        .progress-bar {
            height: 10px;
            background: #eee;
            border-radius: 5px;
            margin: 0.5rem 0;
            overflow: hidden;
            position: relative;
        }
        .progress {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.3s;
        }
        .progress-text {
            text-align: center;
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
        }
        .alert {
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            display: flex;
            align-items: flex-start;
            gap: 0.8rem;
        }
        .alert-success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
        }
        .alert-error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }
        .alert-warning {
            background: #fff8e1;
            color: #ff8f00;
            border-left: 4px solid #ff8f00;
        }
        .alert-info {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #1565c0;
        }
        #folderInfo {
            margin: 1rem 0;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid var(--primary);
        }
        #excelPreview {
            margin: 1rem 0;
        }
        .file-input {
            display: none;
        }
        .step-header {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }
        .step-number {
            background: var(--primary);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
        }
        .step-title {
            margin: 0;
            color: var(--primary);
            font-size: 1.3rem;
        }
        .options-container {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }
        .option-card {
            flex: 1;
            min-width: 200px;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .option-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .option-card.selected {
            border: 2px solid var(--primary);
            background: #f0f4ff;
        }
        .option-card h3 {
            margin-top: 0;
            color: var(--primary);
        }
        .option-card p {
            margin-bottom: 0;
            color: #666;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            margin: 1rem 0;
            gap: 0.5rem;
        }
        .checkbox-container input {
            width: 18px;
            height: 18px;
        }
        .checkbox-container label {
            cursor: pointer;
        }
        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .file-count {
            background: var(--primary);
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }
        .file-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #666;
            margin: 0.5rem 0;
        }
        .file-info i {
            color: var(--primary);
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }
        .summary-item:last-child {
            border-bottom: none;
        }
        .summary-value {
            font-weight: 500;
        }
        .error-list {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: rgba(255,255,255,0.7);
            border-radius: 4px;
        }
        .error-item {
            font-size: 0.85rem;
            color: var(--error);
            margin-bottom: 0.3rem;
            padding-left: 1rem;
            position: relative;
        }
        .error-item:before {
            content: "•";
            position: absolute;
            left: 0;
        }
        .rename-pattern {
            margin: 1rem 0;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .rename-pattern input, .rename-pattern select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 0.5rem;
        }
        .rename-pattern label {
            margin-right: 1rem;
            font-weight: 500;
        }
        .rename-pattern .pattern-preview {
            margin-top: 0.5rem;
            font-family: monospace;
            color: var(--primary);
        }
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            .options-container {
                flex-direction: column;
            }
            .action-buttons {
                flex-direction: column;
            }
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-images"></i> Renombrador de Imágenes Avanzado</h1>
        
        <div class="step active" id="step1">
            <div class="step-header">
                <div class="step-number">1</div>
                <h2 class="step-title">Seleccionar Carpeta</h2>
            </div>
            <p>Selecciona la carpeta que contiene las imágenes que deseas renombrar. Se admiten formatos: JPG, PNG, GIF, BMP, WEBP.</p>
            
            <button id="selectFolder" class="btn">
                <i class="fas fa-folder-open"></i> Elegir Carpeta con Imágenes
            </button>
            
            <div id="folderInfo" style="display: none;">
                <div class="file-info">
                    <i class="fas fa-folder"></i>
                    <span id="folderName"></span>
                </div>
                <div class="file-info">
                    <i class="fas fa-image"></i>
                    <span id="fileCount"></span> archivos encontrados
                </div>
                <div class="file-info">
                    <i class="fas fa-info-circle"></i>
                    <span id="folderMessage"></span>
                </div>
            </div>
        </div>

        <div class="step" id="step2">
            <div class="step-header">
                <div class="step-number">2</div>
                <h2 class="step-title">Configurar Renombrado</h2>
            </div>
            
            <div id="fileListContainer">
                <h3>Archivos encontrados <span id="fileCountBadge" class="file-count">0</span></h3>
                <div id="fileList">
                    <p>No se han cargado archivos aún.</p>
                </div>
            </div>
            
            <h3>Opciones de renombrado</h3>
            <div class="options-container">
                <div class="option-card" id="optionCustom">
                    <h3><i class="fas fa-edit"></i> Renombrar selectivamente</h3>
                    <p>Descarga una plantilla Excel donde puedes especificar qué archivos renombrar y cuáles dejar igual.</p>
                </div>
                <div class="option-card" id="optionAll">
                    <h3><i class="fas fa-redo"></i> Renombrar todos</h3>
                    <p>Descarga una plantilla Excel para renombrar todos los archivos secuencialmente (ej: imagen1.jpg, imagen2.jpg).</p>
                </div>
                <div class="option-card" id="optionPattern">
                    <h3><i class="fas fa-magic"></i> Patrón de renombrado</h3>
                    <p>Define un patrón para renombrar automáticamente todos los archivos (ej: producto_[num].jpg).</p>
                </div>
            </div>
            
            <div id="patternOptions" style="display: none;">
                <div class="rename-pattern">
                    <h4>Configurar patrón de nombres</h4>
                    <div>
                        <label>Prefijo:</label>
                        <input type="text" id="prefix" placeholder="producto" value="imagen">
                    </div>
                    <div style="margin-top: 0.5rem;">
                        <label>Numeración:</label>
                        <select id="numberingType">
                            <option value="sequential">Secuencial (1, 2, 3...)</option>
                            <option value="zeros">Con ceros (001, 002...)</option>
                        </select>
                        <label>Iniciar desde:</label>
                        <input type="number" id="startNumber" min="1" value="1" style="width: 60px;">
                    </div>
                    <div style="margin-top: 0.5rem;">
                        <label>Sufijo:</label>
                        <input type="text" id="suffix" placeholder="_final" value="">
                    </div>
                    <div class="pattern-preview" id="patternPreview">Ejemplo: imagen1.jpg</div>
                </div>
            </div>
            
            <div class="checkbox-container">
                <input type="checkbox" id="flattenStructure" checked>
                <label for="flattenStructure">Aplanar estructura de carpetas (todas las imágenes en una sola carpeta)</label>
            </div>
            
            <div class="checkbox-container">
                <input type="checkbox" id="preserveOriginals" checked>
                <label for="preserveOriginals">Mantener archivos originales (crear copias renombradas)</label>
            </div>
            
            <div class="action-buttons">
                <button id="downloadTemplate" class="btn" disabled>
                    <i class="fas fa-file-excel"></i> Descargar Plantilla
                </button>
                <button id="applyPattern" class="btn" disabled style="display: none;">
                    <i class="fas fa-check"></i> Aplicar Patrón
                </button>
                <button id="skipTemplate" class="btn btn-secondary">
                    <i class="fas fa-forward"></i> Saltar este paso
                </button>
            </div>
        </div>

        <div class="step" id="step3">
            <div class="step-header">
                <div class="step-number">3</div>
                <h2 class="step-title">Cargar Cambios</h2>
            </div>
            
            <div id="uploadInstructions">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <p><strong>Instrucciones:</strong></p>
                        <ol>
                            <li>Edita la columna "nuevoNombre" en el Excel descargado</li>
                            <li>No modifiques las columnas "rutaOriginal" o "nombreActual"</li>
                            <li>No incluyas la extensión en "nuevoNombre"</li>
                            <li>Deja vacío "nuevoNombre" si no quieres cambiar ese archivo</li>
                            <li>Guarda el archivo y súbelo aquí</li>
                        </ol>
                    </div>
                </div>
                
                <button id="uploadExcel" class="btn">
                    <i class="fas fa-upload"></i> Subir Excel Modificado
                </button>
                <input type="file" id="excelFile" class="file-input" accept=".xlsx,.xls">
            </div>
            
            <div id="excelPreview" style="display: none;">
                <h3>Vista previa de cambios</h3>
                <div id="changesSummary"></div>
                <div id="changesPreview"></div>
                <div id="warningsContainer"></div>
            </div>
            
            <div class="action-buttons">
                <button id="continueBtn" class="btn" disabled>
                    <i class="fas fa-arrow-right"></i> Continuar
                </button>
                <button id="backToOptionsBtn" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Volver a opciones
                </button>
            </div>
        </div>

        <div class="step" id="step4">
            <div class="step-header">
                <div class="step-number">4</div>
                <h2 class="step-title">Procesar Archivos</h2>
            </div>
            
            <div id="processOptions">
                <h3>Resumen de cambios</h3>
                <div id="finalSummary"></div>
                
                <button id="processBtn" class="btn">
                    <i class="fas fa-cogs"></i> Generar Archivos Renombrados
                </button>
            </div>
            
            <div class="progress-container" style="display: none;" id="progressContainer">
                <h3>Progreso</h3>
                <div class="progress-bar">
                    <div class="progress" id="progressBar"></div>
                </div>
                <div class="progress-text" id="progressText">0% completado</div>
            </div>
            
            <div id="resultContainer"></div>
            
            <div class="action-buttons">
                <button id="newProcessBtn" class="btn btn-secondary" style="display: none;">
                    <i class="fas fa-sync-alt"></i> Nuevo Proceso
                </button>
                <button id="downloadLogBtn" class="btn" style="display: none;">
                    <i class="fas fa-download"></i> Descargar Registro
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Variables globales
        let imageFiles = [];
        let folderHandle = null;
        let resultFolderHandle = null;
        let excelData = [];
        let selectedOption = null;
        let flattenStructure = true;
        let preserveOriginals = true;
        let processingErrors = [];
        let renameLog = [];
        let currentTemplateType = null;

        // Elementos del DOM
        const selectFolderBtn = document.getElementById('selectFolder');
        const downloadTemplateBtn = document.getElementById('downloadTemplate');
        const applyPatternBtn = document.getElementById('applyPattern');
        const skipTemplateBtn = document.getElementById('skipTemplate');
        const uploadExcelBtn = document.getElementById('uploadExcel');
        const excelFileInput = document.getElementById('excelFile');
        const continueBtn = document.getElementById('continueBtn');
        const backToOptionsBtn = document.getElementById('backToOptionsBtn');
        const processBtn = document.getElementById('processBtn');
        const newProcessBtn = document.getElementById('newProcessBtn');
        const downloadLogBtn = document.getElementById('downloadLogBtn');
        const optionCustom = document.getElementById('optionCustom');
        const optionAll = document.getElementById('optionAll');
        const optionPattern = document.getElementById('optionPattern');
        const flattenCheckbox = document.getElementById('flattenStructure');
        const preserveOriginalsCheckbox = document.getElementById('preserveOriginals');
        
        const fileList = document.getElementById('fileList');
        const excelPreview = document.getElementById('excelPreview');
        const changesSummary = document.getElementById('changesSummary');
        const changesPreview = document.getElementById('changesPreview');
        const warningsContainer = document.getElementById('warningsContainer');
        const finalSummary = document.getElementById('finalSummary');
        const resultContainer = document.getElementById('resultContainer');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        
        const folderInfo = document.getElementById('folderInfo');
        const folderName = document.getElementById('folderName');
        const fileCount = document.getElementById('fileCount');
        const folderMessage = document.getElementById('folderMessage');
        const fileCountBadge = document.getElementById('fileCountBadge');
        
        const patternOptions = document.getElementById('patternOptions');
        const prefixInput = document.getElementById('prefix');
        const suffixInput = document.getElementById('suffix');
        const numberingTypeSelect = document.getElementById('numberingType');
        const startNumberInput = document.getElementById('startNumber');
        const patternPreview = document.getElementById('patternPreview');
        
        const steps = document.querySelectorAll('.step');

        // Event Listeners
        selectFolderBtn.addEventListener('click', selectFolder);
        downloadTemplateBtn.addEventListener('click', generateExcel);
        applyPatternBtn.addEventListener('click', applyPattern);
        skipTemplateBtn.addEventListener('click', skipTemplateStep);
        uploadExcelBtn.addEventListener('click', () => excelFileInput.click());
        excelFileInput.addEventListener('change', handleExcelUpload);
        continueBtn.addEventListener('click', () => goToStep(4));
        backToOptionsBtn.addEventListener('click', () => goToStep(2));
        processBtn.addEventListener('click', processFiles);
        newProcessBtn.addEventListener('click', resetProcess);
        downloadLogBtn.addEventListener('click', downloadLog);
        
        optionCustom.addEventListener('click', () => selectOption('custom'));
        optionAll.addEventListener('click', () => selectOption('all'));
        optionPattern.addEventListener('click', () => selectOption('pattern'));
        
        flattenCheckbox.addEventListener('change', (e) => {
            flattenStructure = e.target.checked;
            if (excelData.length) showFinalSummary();
        });
        
        preserveOriginalsCheckbox.addEventListener('change', (e) => {
            preserveOriginals = e.target.checked;
        });
        
        // Eventos para actualizar vista previa del patrón
        prefixInput.addEventListener('input', updatePatternPreview);
        suffixInput.addEventListener('input', updatePatternPreview);
        numberingTypeSelect.addEventListener('change', updatePatternPreview);
        startNumberInput.addEventListener('input', updatePatternPreview);

        // 1. Seleccionar carpeta
        async function selectFolder() {
            try {
                resetState();
                
                // Mostrar indicador de carga
                selectFolderBtn.disabled = true;
                selectFolderBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Explorando carpeta...';
                
                folderHandle = await window.showDirectoryPicker();
                imageFiles = await getImageFiles(folderHandle);
                
                // Actualizar UI
                selectFolderBtn.innerHTML = '<i class="fas fa-folder-open"></i> Carpeta seleccionada';
                folderInfo.style.display = 'block';
                folderName.textContent = folderHandle.name;
                fileCount.textContent = imageFiles.length;
                fileCountBadge.textContent = imageFiles.length;
                
                if (imageFiles.length === 0) {
                    folderMessage.textContent = 'No se encontraron imágenes válidas (formatos soportados: .jpg, .jpeg, .png, .gif, .bmp, .webp)';
                    folderMessage.style.color = 'var(--error)';
                } else {
                    folderMessage.textContent = 'Carpeta cargada correctamente. Continúa al siguiente paso.';
                    folderMessage.style.color = 'var(--success)';
                }
                
                showFilePreview();
                goToStep(2);
                downloadTemplateBtn.disabled = imageFiles.length === 0;
                
            } catch (error) {
                console.error("Error al seleccionar carpeta:", error);
                if (error.name !== 'AbortError') {
                    showAlert('error', 'Error al seleccionar carpeta', error.message);
                }
                selectFolderBtn.disabled = false;
                selectFolderBtn.innerHTML = '<i class="fas fa-folder-open"></i> Elegir Carpeta con Imágenes';
            }
        }

        // Obtener imágenes recursivamente
        async function getImageFiles(dirHandle, path = '') {
            const files = [];
            const allowedExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
            
            for await (const entry of dirHandle.values()) {
                if (entry.kind === 'file') {
                    const fileName = entry.name;
                    const lastDotIndex = fileName.lastIndexOf('.');
                    
                    if (lastDotIndex === -1) continue; // Saltar archivos sin extensión
                    
                    const extension = fileName.slice(lastDotIndex).toLowerCase();
                    if (allowedExtensions.includes(extension)) {
                        const file = await entry.getFile();
                        files.push({
                            name: fileName,
                            handle: entry,
                            extension: extension,
                            path: path,
                            fullPath: path ? `${path}/${fileName}` : fileName,
                            size: file.size,
                            lastModified: file.lastModified
                        });
                    }
                } else if (entry.kind === 'directory') {
                    const subPath = path ? `${path}/${entry.name}` : entry.name;
                    const subFiles = await getImageFiles(entry, subPath);
                    files.push(...subFiles);
                }
            }
            
            return files;
        }

        // Mostrar vista previa de archivos
        function showFilePreview() {
            if (imageFiles.length === 0) {
                fileList.innerHTML = '<p>No se encontraron imágenes válidas.</p>';
                return;
            }
            
            let html = '';
            imageFiles.slice(0, 100).forEach(file => {
                const sizeKB = Math.round(file.size / 1024);
                html += `
                    <div class="file-item">
                        <span class="file-path">${file.fullPath}</span>
                        <span class="file-size">${sizeKB} KB</span>
                    </div>
                `;
            });
            
            if (imageFiles.length > 100) {
                html += `<div class="file-item">... y ${imageFiles.length - 100} archivos más</div>`;
            }
            
            fileList.innerHTML = html;
        }

        // 2. Seleccionar opción de renombrado
        function selectOption(option) {
            selectedOption = option;
            
            // Actualizar UI
            optionCustom.classList.remove('selected');
            optionAll.classList.remove('selected');
            optionPattern.classList.remove('selected');
            
            if (option === 'custom') {
                optionCustom.classList.add('selected');
                downloadTemplateBtn.style.display = 'inline-flex';
                applyPatternBtn.style.display = 'none';
                patternOptions.style.display = 'none';
            } else if (option === 'all') {
                optionAll.classList.add('selected');
                downloadTemplateBtn.style.display = 'inline-flex';
                applyPatternBtn.style.display = 'none';
                patternOptions.style.display = 'none';
            } else {
                optionPattern.classList.add('selected');
                downloadTemplateBtn.style.display = 'none';
                applyPatternBtn.style.display = 'inline-flex';
                patternOptions.style.display = 'block';
                updatePatternPreview();
            }
            
            downloadTemplateBtn.disabled = false;
            applyPatternBtn.disabled = false;
        }

        // Actualizar vista previa del patrón
        function updatePatternPreview() {
            const prefix = prefixInput.value.trim() || 'imagen';
            const suffix = suffixInput.value.trim();
            const numberingType = numberingTypeSelect.value;
            const startNumber = parseInt(startNumberInput.value) || 1;
            
            let exampleNumber;
            if (numberingType === 'zeros') {
                exampleNumber = startNumber.toString().padStart(3, '0');
            } else {
                exampleNumber = startNumber;
            }
            
            const exampleName = `${prefix}${exampleNumber}${suffix}.jpg`;
            patternPreview.textContent = `Ejemplo: ${exampleName}`;
        }

        // Aplicar patrón de renombrado
        function applyPattern() {
            const prefix = prefixInput.value.trim() || 'imagen';
            const suffix = suffixInput.value.trim();
            const numberingType = numberingTypeSelect.value;
            let currentNumber = parseInt(startNumberInput.value) || 1;
            
            excelData = imageFiles.map(file => {
                let newName;
                
                if (numberingType === 'zeros') {
                    const paddedNumber = currentNumber.toString().padStart(3, '0');
                    newName = `${prefix}${paddedNumber}${suffix}`;
                } else {
                    newName = `${prefix}${currentNumber}${suffix}`;
                }
                
                currentNumber++;
                
                return {
                    rutaOriginal: file.fullPath,
                    nombreActual: file.name,
                    nuevoNombre: newName,
                    extension: file.extension
                };
            });
            
            showExcelPreview();
            continueBtn.disabled = false;
            
            showAlert('success', 'Patrón aplicado', 
                `Se han generado nombres para ${imageFiles.length} archivos usando el patrón definido.`);
        }

        // Generar Excel según la opción seleccionada
        function generateExcel() {
            if (!selectedOption || imageFiles.length === 0) return;
            
            currentTemplateType = selectedOption;
            
            if (selectedOption === 'all') {
                // Plantilla para renombrar todos los archivos secuencialmente
                excelData = imageFiles.map((file, index) => ({
                    rutaOriginal: file.fullPath,
                    nombreActual: file.name,
                    nuevoNombre: `imagen_${index + 1}`,
                    extension: file.extension
                }));
            } else {
                // Plantilla para renombrado selectivo
                excelData = imageFiles.map(file => ({
                    rutaOriginal: file.fullPath,
                    nombreActual: file.name,
                    nuevoNombre: '',
                    extension: file.extension
                }));
            }
            
            // Crear hoja de cálculo
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Imágenes");
            
            // Hoja de instrucciones
            const instructions = [
                ["INSTRUCCIONES PARA RENOMBRAR IMÁGENES"],
                ["", "", "", ""],
                ["rutaOriginal", "NO MODIFICAR", "Ruta completa del archivo original", ""],
                ["nombreActual", "NO MODIFICAR", "Nombre actual del archivo (con extensión)", ""],
                ["nuevoNombre", "EDITAR", "Nuevo nombre (sin extensión)", "Dejar vacío para no cambiar"],
                ["extension", "NO MODIFICAR", "Extensión del archivo", ""],
                ["", "", "", ""],
                ["RECOMENDACIONES:"],
                ["- No usar caracteres especiales: / \\ : * ? \" < > |"],
                ["- No incluir la extensión en nuevoNombre (se agregará automáticamente)"],
                ["- Verificar que no haya nombres duplicados"],
                ["- Guardar el archivo en formato Excel (.xlsx)"],
                ["", "", "", ""],
                ["PROCESO:"],
                ["1. Editar la columna nuevoNombre"],
                ["2. Guardar el archivo"],
                ["3. Subirlo en el paso 3 de la aplicación"]
            ];
            
            const instructionWs = XLSX.utils.aoa_to_sheet(instructions);
            XLSX.utils.book_append_sheet(wb, instructionWs, "Instrucciones");
            
            // Descargar archivo
            const date = new Date().toISOString().split('T')[0];
            const fileName = selectedOption === 'all' 
                ? `plantilla_renombrar_todos_${date}.xlsx` 
                : `plantilla_renombrar_selectivo_${date}.xlsx`;
            
            XLSX.writeFile(wb, fileName);
            
            // Mostrar mensaje
            showAlert('success', 'Plantilla generada', 
                `Se ha descargado el archivo ${fileName}. Edítalo y súbelo en el siguiente paso.`);
            
            goToStep(3);
        }

        // Saltar paso de plantilla (renombrar todos secuencialmente)
        function skipTemplateStep() {
            selectedOption = 'all';
            currentTemplateType = 'all';
            
            excelData = imageFiles.map((file, index) => ({
                rutaOriginal: file.fullPath,
                nombreActual: file.name,
                nuevoNombre: `imagen_${index + 1}`,
                extension: file.extension
            }));
            
            showExcelPreview();
            continueBtn.disabled = false;
            
            showAlert('info', 'Modo rápido activado', 
                'Todos los archivos serán renombrados secuencialmente (ej: imagen1.jpg, imagen2.jpg).');
        }

        // 3. Manejar Excel subido
        function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    excelData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    // Validar formato básico
                    if (!excelData[0]?.nombreActual) {
                        showAlert('error', 'Formato incorrecto', 
                            'El archivo Excel no tiene el formato esperado. Asegúrate de usar la plantilla descargada.');
                        return;
                    }
                    
                    // Asegurar que exista columna nuevoNombre
                    if (!excelData[0].hasOwnProperty('nuevoNombre')) {
                        excelData = excelData.map(item => ({ 
                            ...item, 
                            nuevoNombre: '',
                            extension: item.extension || item.nombreActual.split('.').pop()
                        }));
                    }
                    
                    // Mostrar vista previa
                    showExcelPreview();
                    continueBtn.disabled = false;
                    
                } catch (error) {
                    console.error("Error al procesar Excel:", error);
                    showAlert('error', 'Error al procesar Excel', 
                        'El archivo no es un Excel válido o está corrupto. Intenta nuevamente.');
                }
            };
            reader.onerror = function() {
                showAlert('error', 'Error de lectura', 'No se pudo leer el archivo Excel.');
            };
            reader.readAsArrayBuffer(file);
        }

        // Mostrar vista previa del Excel
        function showExcelPreview() {
            const changes = excelData.filter(item => item.nuevoNombre && item.nuevoNombre.trim() !== '');
            const noChanges = excelData.length - changes.length;
            
            // Resumen de cambios
            changesSummary.innerHTML = `
                <div class="alert ${changes.length ? 'alert-success' : 'alert-warning'}">
                    <i class="fas ${changes.length ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                    <div>
                        <strong>${changes.length} archivos serán renombrados</strong>
                        ${noChanges > 0 ? `, ${noChanges} permanecerán igual` : ''}
                    </div>
                </div>
            `;
            
            // Vista previa de cambios
            let previewHtml = `
                <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 1rem; margin: 1rem 0; background: #fafafa;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f0f0f0;">
                                <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid #ddd;">Original</th>
                                <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid #ddd;">→</th>
                                <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid #ddd;">Nuevo</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            changes.slice(0, 10).forEach(item => {
                const ext = item.extension || item.nombreActual.split('.').pop();
                const newName = item.nuevoNombre.endsWith(`.${ext}`) 
                    ? item.nuevoNombre 
                    : `${item.nuevoNombre}.${ext}`;
                
                previewHtml += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 0.5rem; word-break: break-all;">${item.nombreActual}</td>
                        <td style="padding: 0.5rem;">→</td>
                        <td style="padding: 0.5rem; color: var(--primary); font-weight: 500;">${newName}</td>
                    </tr>
                `;
            });
            
            if (changes.length > 10) {
                previewHtml += `
                    <tr>
                        <td colspan="3" style="padding: 0.5rem; text-align: center; color: #666;">
                            ... y ${changes.length - 10} cambios más
                        </td>
                    </tr>
                `;
            }
            
            previewHtml += `</tbody></table></div>`;
            changesPreview.innerHTML = previewHtml;
            
            // Verificación de nombres duplicados
            const newNames = changes.map(item => {
                const ext = item.extension || item.nombreActual.split('.').pop();
                return item.nuevoNombre.endsWith(`.${ext}`) 
                    ? item.nuevoNombre 
                    : `${item.nuevoNombre}.${ext}`;
            });
            
            const duplicates = findDuplicates(newNames);
            if (duplicates.length) {
                warningsContainer.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <strong>Advertencia: Hay ${duplicates.length} nombres duplicados</strong>
                            <p>Los siguientes nombres aparecen más de una vez:</p>
                            <div style="max-height: 100px; overflow-y: auto; background: rgba(255,255,255,0.5); padding: 0.5rem; border-radius: 4px;">
                                ${duplicates.slice(0, 5).map(name => `<div>• ${name}</div>`).join('')}
                                ${duplicates.length > 5 ? `<div>... y ${duplicates.length - 5} más</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                warningsContainer.innerHTML = '';
            }
            
            excelPreview.style.display = 'block';
            
            // Mostrar resumen para el paso 4
            showFinalSummary();
        }

        // Mostrar resumen final antes de procesar
        function showFinalSummary() {
            const changes = excelData.filter(item => item.nuevoNombre && item.nuevoNombre.trim() !== '');
            const noChanges = excelData.length - changes.length;
            
            let summaryHtml = `
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                    <h4 style="margin-top: 0;">Resumen de cambios</h4>
                    <div class="summary-item">
                        <span>Total de archivos:</span>
                        <span class="summary-value">${excelData.length}</span>
                    </div>
                    <div class="summary-item">
                        <span>Archivos a renombrar:</span>
                        <span class="summary-value" style="color: var(--primary);">${changes.length}</span>
                    </div>
                    <div class="summary-item">
                        <span>Archivos sin cambios:</span>
                        <span class="summary-value">${noChanges}</span>
                    </div>
                    <div class="summary-item">
                        <span>Estructura:</span>
                        <span class="summary-value">${flattenStructure ? 'Aplanada (todas en una carpeta)' : 'Mantener estructura original'}</span>
                    </div>
                    <div class="summary-item">
                        <span>Archivos originales:</span>
                        <span class="summary-value">${preserveOriginals ? 'Se conservarán' : 'Se reemplazarán'}</span>
                    </div>
            `;
            
            // Verificar si hay nombres inválidos
            const invalidNames = changes.filter(item => {
                const name = item.nuevoNombre.trim();
                return /[\\/:*?"<>|]/.test(name);
            });
            
            if (invalidNames.length > 0) {
                summaryHtml += `
                    <div class="summary-item" style="color: var(--error);">
                        <span>Nombres inválidos:</span>
                        <span class="summary-value">${invalidNames.length}</span>
                    </div>
                    <div style="margin-top: 0.5rem; color: var(--error); font-size: 0.9rem;">
                        <i class="fas fa-exclamation-triangle"></i> Algunos nombres contienen caracteres no permitidos (\\ / : * ? " < > |)
                    </div>
                `;
            }
            
            summaryHtml += `</div>`;
            finalSummary.innerHTML = summaryHtml;
        }

        // 4. Procesar archivos y crear carpeta IMGSRESULTADORENAME
        async function processFiles() {
            if (!excelData.length) {
                showAlert('error', 'Error', 'No hay datos para procesar');
                return;
            }
            
            const changes = excelData.filter(item => item.nuevoNombre && item.nuevoNombre.trim() !== '');
            if (!changes.length) {
                showAlert('error', 'Error', 'No hay nombres nuevos asignados en el Excel');
                return;
            }
            
            // Verificar nombres inválidos
            const invalidNames = changes.filter(item => {
                const name = item.nuevoNombre.trim();
                return /[\\/:*?"<>|]/.test(name);
            });
            
            if (invalidNames.length) {
                showAlert('error', 'Nombres inválidos', 
                    `${invalidNames.length} nombres contienen caracteres no permitidos (\\ / : * ? " < > |). Corrígelos antes de continuar.`);
                return;
            }
            
            // Verificar duplicados
            const newNames = changes.map(item => {
                const ext = item.extension || item.nombreActual.split('.').pop();
                return item.nuevoNombre.endsWith(`.${ext}`) 
                    ? item.nuevoNombre 
                    : `${item.nuevoNombre}.${ext}`;
            });
            
            const duplicates = findDuplicates(newNames);
            if (duplicates.length) {
                showAlert('error', 'Nombres duplicados', 
                    `Hay ${duplicates.length} nombres duplicados. Corrígelos antes de continuar.`);
                return;
            }
            
            try {
                processingErrors = [];
                renameLog = [];
                let processed = 0;
                let skipped = 0;
                
                // Configurar UI de progreso
                processBtn.disabled = true;
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                progressText.textContent = '0% completado';
                
                // Solicitar permiso para crear carpeta de resultados
                try {
                    resultFolderHandle = await folderHandle.getDirectoryHandle('IMGSRESULTADORENAME', { create: true });
                } catch (error) {
                    showAlert('error', 'Error al crear carpeta', 
                        'No se pudo crear la carpeta IMGSRESULTADORENAME. Verifica los permisos.');
                    throw error;
                }
                
                // Procesar solo los archivos con cambios
                for (const item of changes) {
                    try {
                        const originalFile = imageFiles.find(f => 
                            f.name === item.nombreActual && f.fullPath === item.rutaOriginal);
                        
                        if (!originalFile) {
                            skipped++;
                            processingErrors.push(`No se encontró el archivo original: ${item.rutaOriginal}`);
                            renameLog.push({
                                original: item.rutaOriginal,
                                newName: '',
                                status: 'Error: Archivo no encontrado',
                                error: true
                            });
                            continue;
                        }
                        
                        const file = await originalFile.handle.getFile();
                        const extension = item.extension || item.nombreActual.split('.').pop();
                        
                        // Generar nombre final
                        let finalName = item.nuevoNombre.trim();
                        
                        // Asegurar que tenga la extensión correcta
                        if (!finalName.toLowerCase().endsWith(`.${extension}`)) {
                            finalName += `.${extension}`;
                        }
                        
                        // Crear estructura de carpetas si no se aplanan
                        let targetFolder = resultFolderHandle;
                        if (!flattenStructure) {
                            const pathParts = item.rutaOriginal.split('/').slice(0, -1);
                            for (const part of pathParts) {
                                targetFolder = await targetFolder.getDirectoryHandle(part, { create: true });
                            }
                        }
                        
                        // Crear el archivo renombrado
                        try {
                            const newFileHandle = await targetFolder.getFileHandle(finalName, { create: true });
                            const writable = await newFileHandle.createWritable();
                            const fileContent = await file.arrayBuffer();
                            await writable.write(fileContent);
                            await writable.close();
                            
                            renameLog.push({
                                original: item.rutaOriginal,
                                newName: flattenStructure ? finalName : `${pathParts.join('/')}/${finalName}`,
                                status: 'OK',
                                error: false
                            });
                            
                            processed++;
                        } catch (error) {
                            processingErrors.push(`Error al crear ${finalName}: ${error.message}`);
                            renameLog.push({
                                original: item.rutaOriginal,
                                newName: finalName,
                                status: `Error: ${error.message}`,
                                error: true
                            });
                            skipped++;
                        }
                        
                        const progress = Math.round((processed / changes.length) * 100);
                        progressBar.style.width = `${progress}%`;
                        progressText.textContent = `${progress}% completado (${processed} de ${changes.length} archivos)`;
                        
                        // Pequeña pausa para permitir que la UI se actualice
                        await new Promise(resolve => setTimeout(resolve, 10));
                        
                    } catch (error) {
                        processingErrors.push(`Error al procesar ${item.rutaOriginal}: ${error.message}`);
                        renameLog.push({
                            original: item.rutaOriginal,
                            newName: '',
                            status: `Error: ${error.message}`,
                            error: true
                        });
                        skipped++;
                    }
                }
                
                if (processed === 0) {
                    showAlert('error', 'Error', 
                        'No se encontraron archivos para renombrar. Verifica que los nombres en el Excel coincidan con los archivos originales.');
                    return;
                }
                
                // Mostrar resultado
                showProcessResult(processed, skipped, changes.length);
                
            } catch (error) {
                console.error("Error:", error);
                showAlert('error', 'Error al procesar', error.message);
                processBtn.disabled = false;
                progressContainer.style.display = 'none';
            }
        }

        // Mostrar resultado del procesamiento
        function showProcessResult(processed, skipped, total) {
            let resultHtml = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    <div>
                        <h3 style="margin-top: 0;">¡Proceso completado!</h3>
                        <div class="summary-item">
                            <span>Archivos procesados:</span>
                            <span class="summary-value" style="color: var(--success);">${processed}</span>
                        </div>
            `;
            
            if (skipped > 0) {
                resultHtml += `
                    <div class="summary-item">
                        <span>Archivos no procesados:</span>
                        <span class="summary-value" style="color: var(--error);">${skipped}</span>
                    </div>
                `;
            }
            
            resultHtml += `
                        <p>Se ha creado una carpeta <strong>IMGSRESULTADORENAME</strong> con las imágenes renombradas.</p>
                        <p>Estructura: <strong>${flattenStructure ? 'Aplanada' : 'Original'}</strong></p>
                        <p>Archivos originales: <strong>${preserveOriginals ? 'Conservados' : 'Reemplazados'}</strong></p>
            `;
            
            if (processingErrors.length > 0) {
                resultHtml += `
                    <div style="margin-top: 1rem;">
                        <h4>Errores encontrados (${processingErrors.length}):</h4>
                        <div class="error-list">
                            ${processingErrors.slice(0, 10).map(error => 
                                `<div class="error-item">${error}</div>`
                            ).join('')}
                            ${processingErrors.length > 10 ? 
                                `<div class="error-item">... y ${processingErrors.length - 10} más</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            resultHtml += `</div></div>`;
            resultContainer.innerHTML = resultHtml;
            
            // Mostrar botones finales
            newProcessBtn.style.display = 'inline-flex';
            downloadLogBtn.style.display = 'inline-flex';
            processBtn.style.display = 'none';
        }

        // Descargar registro de cambios
        function downloadLog() {
            if (!renameLog.length) return;
            
            // Crear hoja de cálculo con el registro
            const ws = XLSX.utils.json_to_sheet(renameLog);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Registro");
            
            // Descargar archivo
            const date = new Date().toISOString().split('T')[0];
            const fileName = `registro_renombrado_${date}.xlsx`;
            
            XLSX.writeFile(wb, fileName);
        }

        // Reiniciar el proceso
        function resetProcess() {
            // Mantener la selección de carpeta pero resetear todo lo demás
            excelData = [];
            processingErrors = [];
            renameLog = [];
            resultFolderHandle = null;
            
            // Resetear UI
            excelPreview.style.display = 'none';
            resultContainer.innerHTML = '';
            progressContainer.style.display = 'none';
            progressBar.style.width = '0%';
            progressText.textContent = '0% completado';
            
            // Mostrar botones adecuados
            newProcessBtn.style.display = 'none';
            downloadLogBtn.style.display = 'none';
            processBtn.style.display = 'inline-flex';
            processBtn.disabled = false;
            
            // Volver al paso 2
            goToStep(2);
        }

        // Helper: Encontrar duplicados
        function findDuplicates(arr) {
            const seen = {};
            const duplicates = [];
            
            arr.forEach(item => {
                if (seen[item]) {
                    if (seen[item] === 1) {
                        duplicates.push(item);
                    }
                    seen[item]++;
                } else {
                    seen[item] = 1;
                }
            });
            
            return duplicates;
        }

        // Mostrar mensaje de alerta
        function showAlert(type, title, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 
                                   type === 'warning' ? 'exclamation-triangle' : 
                                   type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                <div>
                    ${title ? `<strong>${title}</strong>` : ''}
                    ${message}
                </div>
            `;
            
            resultContainer.appendChild(alertDiv);
            setTimeout(() => {
                alertDiv.style.opacity = '1';
            }, 10);
            
            // Auto-ocultar después de 5 segundos (excepto errores)
            if (type !== 'error') {
                setTimeout(() => {
                    alertDiv.style.transition = 'opacity 0.5s';
                    alertDiv.style.opacity = '0';
                    setTimeout(() => {
                        alertDiv.remove();
                    }, 500);
                }, 5000);
            }
        }

        // Navegación entre pasos
        function goToStep(stepNumber) {
            steps.forEach((step, index) => {
                step.classList.toggle('active', index === stepNumber - 1);
            });
            
            // Scroll al inicio del paso
            const activeStep = document.querySelector('.step.active');
            if (activeStep) {
                activeStep.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Resetear estado de la aplicación
        function resetState() {
            imageFiles = [];
            folderHandle = null;
            resultFolderHandle = null;
            excelData = [];
            selectedOption = null;
            processingErrors = [];
            renameLog = [];
            
            // Resetear UI
            fileList.innerHTML = '<p>No se han cargado archivos aún.</p>';
            excelPreview.style.display = 'none';
            excelPreview.innerHTML = '';
            resultContainer.innerHTML = '';
            progressContainer.style.display = 'none';
            progressBar.style.width = '0%';
            progressText.textContent = '0% completado';
            folderInfo.style.display = 'none';
            fileCountBadge.textContent = '0';
            
            // Resetear botones
            downloadTemplateBtn.disabled = true;
            applyPatternBtn.disabled = true;
            continueBtn.disabled = true;
            processBtn.disabled = false;
            processBtn.style.display = 'inline-flex';
            newProcessBtn.style.display = 'none';
            downloadLogBtn.style.display = 'none';
            
            // Resetear opciones
            optionCustom.classList.remove('selected');
            optionAll.classList.remove('selected');
            optionPattern.classList.remove('selected');
            flattenCheckbox.checked = true;
            preserveOriginalsCheckbox.checked = true;
            patternOptions.style.display = 'none';
            downloadTemplateBtn.style.display = 'inline-flex';
            applyPatternBtn.style.display = 'none';
            
            // Resetear valores del patrón
            prefixInput.value = 'imagen';
            suffixInput.value = '';
            numberingTypeSelect.value = 'sequential';
            startNumberInput.value = '1';
            updatePatternPreview();
        }
    </script>
</body>
</html>