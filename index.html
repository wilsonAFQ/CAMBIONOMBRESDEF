<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramienta Avanzada de Archivos</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --error: #f72585;
            --warning: #ff9e00;
            --light: #f8f9fa;
            --dark: #212529;
        }
        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            background: #f5f7ff;
            padding: 1rem;
            margin: 0;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            padding: 2rem;
        }
        h1 {
            color: var(--primary);
            text-align: center;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
        }
        .tab-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .tab-btn {
            background: #e9ecef;
            color: #495057;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }
        .tab-btn.active {
            background: var(--primary);
            color: white;
        }
        .tab-btn:hover:not(.active) {
            background: #dee2e6;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }
        .btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .btn-success {
            background: var(--success);
        }
        .btn-success:hover {
            background: #3ab7d8;
        }
        .btn-danger {
            background: var(--error);
        }
        .btn-danger:hover {
            background: #e51777;
        }
        .step {
            display: none;
            padding: 1.5rem;
            border: 1px solid #eee;
            border-radius: 8px;
            margin: 1rem 0;
            background: #fff;
        }
        .step.active {
            display: block;
        }
        #fileList, #compressFileList {
            max-height: 300px;
            overflow-y: auto;
            margin: 1rem 0;
            border: 1px solid #ddd;
            padding: 1rem;
            border-radius: 5px;
            background: #fafafa;
        }
        .file-item {
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        .file-item:hover {
            background: #f0f4ff;
        }
        .file-item .file-icon {
            color: #6c757d;
            margin-right: 0.5rem;
        }
        .progress-container {
            margin: 1.5rem 0;
        }
        .progress-bar {
            height: 10px;
            background: #eee;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        .progress {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.3s;
        }
        .progress-text {
            font-size: 0.9rem;
            color: #6c757d;
            text-align: right;
        }
        .alert-box {
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.8rem;
        }
        .alert-success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
        }
        .alert-error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }
        .alert-warning {
            background: #fff8e1;
            color: #e65100;
            border-left: 4px solid #e65100;
        }
        .alert-info {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #1565c0;
        }
        #folderInfo, #compressFolderInfo {
            margin: 1rem 0;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #6c757d;
        }
        #excelPreview {
            margin: 1.5rem 0;
        }
        .file-input {
            display: none;
        }
        .step-header {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }
        .step-number {
            background: var(--primary);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 500;
            flex-shrink: 0;
        }
        .step-title {
            margin: 0;
            color: var(--primary);
            font-size: 1.3rem;
        }
        .step-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }
        .preview-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 1rem;
            margin: 1rem 0;
            background: #fff;
            border-radius: 5px;
        }
        .preview-item {
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
            font-family: monospace;
            font-size: 0.9rem;
        }
        .preview-item:hover {
            background: #f5f5f5;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }
        .summary-item:last-child {
            border-bottom: none;
        }
        .file-count {
            font-weight: bold;
            color: var(--primary);
        }
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 0.5rem;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            font-weight: normal;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            margin: 1rem 0;
        }
        .checkbox-container input {
            margin-right: 0.5rem;
        }
        .settings-section {
            margin: 1.5rem 0;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .settings-title {
            margin-top: 0;
            font-size: 1.1rem;
            color: #495057;
        }
        .file-type-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin: 1rem 0;
        }
        .file-type-option {
            display: flex;
            align-items: center;
        }
        .file-type-option label {
            margin-left: 0.3rem;
        }
        .compress-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }
        .compress-option {
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background: #f8f9fa;
        }
        .compress-option h3 {
            margin-top: 0;
            color: var(--primary);
        }
        .compress-option label {
            display: block;
            margin-bottom: 0.5rem;
        }
        .compress-option input[type="number"],
        .compress-option input[type="text"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        .rename-pattern {
            margin: 1.5rem 0;
        }
        .rename-pattern input {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-family: monospace;
        }
        .rename-pattern-info {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 0.5rem;
        }
        .rename-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }
        .rename-option {
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background: #f8f9fa;
        }
        .rename-option h3 {
            margin-top: 0;
            color: var(--primary);
        }
        .rename-option label {
            display: block;
            margin-bottom: 0.5rem;
        }
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            .step {
                padding: 1rem;
            }
            .step-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
            .btn {
                width: 100%;
                justify-content: center;
            }
            .compress-options, .rename-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <i class="fas fa-file-archive"></i> 
            <span>Herramienta Avanzada de Archivos</span>
        </h1>
        
        <div class="tab-buttons">
            <button class="tab-btn active" data-tab="rename-tab">
                <i class="fas fa-images"></i> Renombrar Imágenes
            </button>
            <button class="tab-btn" data-tab="compress-tab">
                <i class="fas fa-file-archive"></i> Comprimir Archivos
            </button>
        </div>
        
        <!-- Pestaña de Renombrar Imágenes -->
        <div id="rename-tab" class="tab-content active">
            <!-- Paso 1: Seleccionar carpeta -->
            <div class="step active" id="step1">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <h2 class="step-title">Seleccionar Carpeta</h2>
                </div>
                
                <p>Selecciona una carpeta que contenga las imágenes que deseas renombrar.</p>
                
                <button id="selectFolder" class="btn">
                    <i class="fas fa-folder-open"></i> Elegir Carpeta con Imágenes
                </button>
                
                <div id="folderInfo" style="display: none;">
                    <div class="summary-item">
                        <span>Carpeta seleccionada:</span>
                        <span id="folderName" class="file-count"></span>
                    </div>
                    <div class="summary-item">
                        <span>Archivos encontrados:</span>
                        <span id="fileCount" class="file-count">0</span>
                    </div>
                    <div class="summary-item">
                        <span>Tamaño total:</span>
                        <span id="totalSize" class="file-count">0 MB</span>
                    </div>
                </div>
                
                <div id="fileTypeSettings" class="settings-section" style="display: none;">
                    <h3 class="settings-title">Filtro de Tipos de Archivo</h3>
                    <p>Selecciona los tipos de archivo que deseas incluir:</p>
                    <div class="file-type-filter">
                        <div class="file-type-option">
                            <input type="checkbox" id="filterJpg" checked>
                            <label for="filterJpg">JPG/JPEG</label>
                        </div>
                        <div class="file-type-option">
                            <input type="checkbox" id="filterPng" checked>
                            <label for="filterPng">PNG</label>
                        </div>
                        <div class="file-type-option">
                            <input type="checkbox" id="filterGif" checked>
                            <label for="filterGif">GIF</label>
                        </div>
                        <div class="file-type-option">
                            <input type="checkbox" id="filterBmp" checked>
                            <label for="filterBmp">BMP</label>
                        </div>
                        <div class="file-type-option">
                            <input type="checkbox" id="filterWebp" checked>
                            <label for="filterWebp">WEBP</label>
                        </div>
                        <div class="file-type-option">
                            <input type="checkbox" id="filterOther" checked>
                            <label for="filterOther">OTROS</label>
                        </div>
                    </div>
                </div>
                
                <div id="fileListContainer" style="display: none;">
                    <h3>Vista Previa de Archivos</h3>
                    <div id="fileList" class="preview-container">
                        <p>No se han cargado archivos aún.</p>
                    </div>
                </div>
                
                <div class="step-actions">
                    <button id="nextStep1" class="btn" disabled>
                        <i class="fas fa-arrow-right"></i> Siguiente
                    </button>
                </div>
            </div>

            <!-- Paso 2: Configurar renombrado -->
            <div class="step" id="step2">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <h2 class="step-title">Configurar Renombrado</h2>
                </div>
                
                <div class="settings-section">
                    <h3 class="settings-title">Opciones de Renombrado</h3>
                    
                    <div class="checkbox-container">
                        <input type="radio" id="renameAll" name="renameOption" value="all" checked>
                        <label for="renameAll">Renombrar todos los archivos</label>
                    </div>
                    
                    <div class="checkbox-container">
                        <input type="radio" id="renameSelected" name="renameOption" value="selected">
                        <label for="renameSelected">Renombrar solo archivos seleccionados</label>
                    </div>
                    
                    <div id="selectFilesSection" style="display: none; margin-top: 1rem;">
                        <p>Sube un archivo Excel o CSV con la lista de archivos a renombrar (solo nombres sin extensión):</p>
                        <button id="uploadFileList" class="btn">
                            <i class="fas fa-upload"></i> Subir Lista de Archivos
                        </button>
                        <input type="file" id="fileListInput" class="file-input" accept=".xlsx,.xls,.csv,.txt">
                        
                        <div id="fileListPreview" style="margin-top: 1rem; display: none;">
                            <h4>Archivos seleccionados para renombrar:</h4>
                            <div id="selectedFilesList" class="preview-container"></div>
                        </div>
                    </div>
                </div>
                
                <div class="rename-options">
                    <div class="rename-option">
                        <h3>Patrón de Renombrado</h3>
                        <div class="rename-pattern">
                            <input type="text" id="renamePattern" placeholder="Ejemplo: imagen_{n}">
                            <div class="rename-pattern-info">
                                <p>Variables disponibles:</p>
                                <ul>
                                    <li><code>{n}</code>: Número secuencial</li>
                                    <li><code>{name}</code>: Nombre original (sin extensión)</li>
                                    <li><code>{date}</code>: Fecha actual (YYYY-MM-DD)</li>
                                    <li><code>{time}</code>: Hora actual (HH-MM-SS)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rename-option">
                        <h3>Opciones Adicionales</h3>
                        <div class="checkbox-container">
                            <input type="checkbox" id="lowercaseNames">
                            <label for="lowercaseNames">Convertir a minúsculas</label>
                        </div>
                        <div class="checkbox-container">
                            <input type="checkbox" id="removeSpaces">
                            <label for="removeSpaces">Reemplazar espacios con guiones</label>
                        </div>
                        <div class="checkbox-container">
                            <input type="checkbox" id="sequentialNumbers" checked>
                            <label for="sequentialNumbers">Numeración secuencial</label>
                        </div>
                    </div>
                </div>
                
                <div class="step-actions">
                    <button id="generateTemplate" class="btn btn-success">
                        <i class="fas fa-file-download"></i> Descargar Plantilla
                    </button>
                    <button id="nextStep2" class="btn">
                        <i class="fas fa-arrow-right"></i> Siguiente
                    </button>
                    <button id="backStep2" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Volver
                    </button>
                </div>
            </div>

            <!-- Paso 3: Cargar Excel -->
            <div class="step" id="step3">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <h2 class="step-title">Cargar Excel Modificado</h2>
                </div>
                
                <p>Sube el archivo Excel que has editado con los nuevos nombres para las imágenes.</p>
                
                <div class="checkbox-container">
                    <input type="checkbox" id="strictMatching" checked>
                    <label for="strictMatching">Coincidencia exacta de nombres</label>
                    <span class="tooltip">
                        <i class="fas fa-question-circle"></i>
                        <span class="tooltiptext">Si está activado, solo se procesarán archivos cuyos nombres coincidan exactamente con los del Excel.</span>
                    </span>
                </div>
                
                <div class="checkbox-container">
                    <input type="checkbox" id="keepOriginalExt" checked>
                    <label for="keepOriginalExt">Mantener extensión original</label>
                </div>
                
                <button id="uploadExcel" class="btn">
                    <i class="fas fa-upload"></i> Subir Excel Modificado
                </button>
                <input type="file" id="excelFile" class="file-input" accept=".xlsx,.xls">
                
                <div id="excelPreview" style="display: none;">
                    <h3>Vista Previa de Cambios</h3>
                    <div id="excelPreviewContent" class="preview-container"></div>
                    <div id="excelValidation" style="margin-top: 1rem;"></div>
                </div>
                
                <div class="step-actions">
                    <button id="nextStep3" class="btn" disabled>
                        <i class="fas fa-arrow-right"></i> Siguiente
                    </button>
                    <button id="backStep3" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Volver
                    </button>
                </div>
            </div>

            <!-- Paso 4: Procesar -->
            <div class="step" id="step4">
                <div class="step-header">
                    <div class="step-number">4</div>
                    <h2 class="step-title">Procesar Cambios</h2>
                </div>
                
                <p>Revisa los cambios y genera los archivos renombrados.</p>
                
                <div id="processSummary" style="display: none;">
                    <h3>Resumen de Cambios</h3>
                    <div class="preview-container">
                        <div class="summary-item">
                            <span>Archivos a renombrar:</span>
                            <span id="filesToRename" class="file-count">0</span>
                        </div>
                        <div class="summary-item">
                            <span>Archivos sin cambios:</span>
                            <span id="filesUnchanged" class="file-count">0</span>
                        </div>
                        <div class="summary-item">
                            <span>Nombres duplicados:</span>
                            <span id="duplicateNames" class="file-count">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3 class="settings-title">Opciones de Salida</h3>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="createZip" checked>
                        <label for="createZip">Crear archivo ZIP con los resultados</label>
                    </div>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="preserveOriginal" checked>
                        <label for="preserveOriginal">Mantener estructura de carpetas original</label>
                    </div>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="includeUnchanged" checked>
                        <label for="includeUnchanged">Incluir archivos sin cambios en el ZIP</label>
                    </div>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="createBackup" checked>
                        <label for="createBackup">Crear copia de seguridad (backup)</label>
                    </div>
                </div>
                
                <div class="progress-container" style="display: none;" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress" id="progress"></div>
                    </div>
                    <div class="progress-text" id="progressText">0% completado</div>
                </div>
                
                <div class="step-actions">
                    <button id="process" class="btn btn-success" disabled>
                        <i class="fas fa-cogs"></i> Procesar Archivos
                    </button>
                    <button id="backStep4" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Volver
                    </button>
                </div>
                
                <div id="result"></div>
            </div>
        </div>
        
        <!-- Pestaña de Comprimir Archivos -->
        <div id="compress-tab" class="tab-content">
            <!-- Paso 1: Seleccionar carpeta -->
            <div class="step active" id="compress-step1">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <h2 class="step-title">Seleccionar Archivos o Carpeta</h2>
                </div>
                
                <p>Selecciona archivos individuales o una carpeta completa para comprimir.</p>
                
                <div class="step-actions">
                    <button id="selectFiles" class="btn">
                        <i class="fas fa-file"></i> Seleccionar Archivos
                    </button>
                    <button id="selectCompressFolder" class="btn">
                        <i class="fas fa-folder-open"></i> Seleccionar Carpeta
                    </button>
                    <input type="file" id="compressFileInput" class="file-input" multiple style="display: none;">
                </div>
                
                <div id="compressFolderInfo" style="display: none;">
                    <div class="summary-item">
                        <span>Elementos seleccionados:</span>
                        <span id="compressItemName" class="file-count"></span>
                    </div>
                    <div class="summary-item">
                        <span>Archivos encontrados:</span>
                        <span id="compressFileCount" class="file-count">0</span>
                    </div>
                    <div class="summary-item">
                        <span>Tamaño total:</span>
                        <span id="compressTotalSize" class="file-count">0 MB</span>
                    </div>
                </div>
                
                <div id="compressFileListContainer" style="display: none;">
                    <h3>Archivos a Comprimir</h3>
                    <div id="compressFileList" class="preview-container">
                        <p>No se han seleccionado archivos aún.</p>
                    </div>
                </div>
                
                <div class="step-actions">
                    <button id="compressNextStep1" class="btn" disabled>
                        <i class="fas fa-arrow-right"></i> Siguiente
                    </button>
                </div>
            </div>
            
            <!-- Paso 2: Configurar compresión -->
            <div class="step" id="compress-step2">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <h2 class="step-title">Configurar Compresión</h2>
                </div>
                
                <div class="compress-options">
                    <div class="compress-option">
                        <h3>Opciones Básicas</h3>
                        <label>
                            <input type="checkbox" id="compressPreservePaths" checked>
                            Mantener estructura de carpetas
                        </label>
                        <label>
                            <input type="checkbox" id="compressIncludeHidden" checked>
                            Incluir archivos ocultos
                        </label>
                    </div>
                    
                    <div class="compress-option">
                        <h3>Nombre del Archivo</h3>
                        <label for="compressFilename">Nombre del archivo ZIP:</label>
                        <input type="text" id="compressFilename" value="archivos_comprimidos" placeholder="Nombre sin extensión">
                    </div>
                    
                    <div class="compress-option">
                        <h3>Opciones Avanzadas</h3>
                        <label for="compressLevel">Nivel de compresión (0-9):</label>
                        <input type="number" id="compressLevel" min="0" max="9" value="6">
                        <label>
                            <input type="checkbox" id="compressSplitFiles">
                            Dividir archivo ZIP en partes de (MB):
                        </label>
                        <input type="number" id="compressSplitSize" min="1" value="100" disabled>
                    </div>
                </div>
                
                <div class="step-actions">
                    <button id="compressProcess" class="btn btn-success">
                        <i class="fas fa-file-archive"></i> Comprimir Archivos
                    </button>
                    <button id="compressBackStep2" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Volver
                    </button>
                </div>
                
                <div class="progress-container" style="display: none;" id="compressProgressContainer">
                    <div class="progress-bar">
                        <div class="progress" id="compressProgress"></div>
                    </div>
                    <div class="progress-text" id="compressProgressText">0% completado</div>
                </div>
                
                <div id="compressResult"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <script>
    // Variables globales para renombrado
    let imageFiles = [];
    let folderHandle;
    let excelData = [];
    let fileTypeFilters = {
        jpg: true,
        png: true,
        gif: true,
        bmp: true,
        webp: true,
        other: true
    };
    let selectedFilesToRename = [];
    
    // Elementos del DOM para renombrado
    const selectFolderBtn = document.getElementById('selectFolder');
    const generateTemplateBtn = document.getElementById('generateTemplate');
    const uploadExcelBtn = document.getElementById('uploadExcel');
    const excelFileInput = document.getElementById('excelFile');
    const processBtn = document.getElementById('process');
    const fileList = document.getElementById('fileList');
    const excelPreview = document.getElementById('excelPreview');
    const excelPreviewContent = document.getElementById('excelPreviewContent');
    const excelValidation = document.getElementById('excelValidation');
    const resultDiv = document.getElementById('result');
    const progressBar = document.getElementById('progress');
    const progressText = document.getElementById('progressText');
    const progressContainer = document.getElementById('progressContainer');
    const steps = document.querySelectorAll('#rename-tab .step');
    const folderInfo = document.getElementById('folderInfo');
    const folderName = document.getElementById('folderName');
    const fileCount = document.getElementById('fileCount');
    const totalSize = document.getElementById('totalSize');
    const fileListContainer = document.getElementById('fileListContainer');
    const processSummary = document.getElementById('processSummary');
    const filesToRename = document.getElementById('filesToRename');
    const filesUnchanged = document.getElementById('filesUnchanged');
    const duplicateNames = document.getElementById('duplicateNames');
    const strictMatching = document.getElementById('strictMatching');
    const keepOriginalExt = document.getElementById('keepOriginalExt');
    const createZip = document.getElementById('createZip');
    const preserveOriginal = document.getElementById('preserveOriginal');
    const includeUnchanged = document.getElementById('includeUnchanged');
    const createBackup = document.getElementById('createBackup');
    
    // Botones de navegación para renombrado
    const nextStep1 = document.getElementById('nextStep1');
    const nextStep2 = document.getElementById('nextStep2');
    const backStep2 = document.getElementById('backStep2');
    const backStep3 = document.getElementById('backStep3');
    const nextStep3 = document.getElementById('nextStep3');
    const backStep4 = document.getElementById('backStep4');
    
    // Opciones de renombrado
    const renameAll = document.getElementById('renameAll');
    const renameSelected = document.getElementById('renameSelected');
    const selectFilesSection = document.getElementById('selectFilesSection');
    const uploadFileList = document.getElementById('uploadFileList');
    const fileListInput = document.getElementById('fileListInput');
    const fileListPreview = document.getElementById('fileListPreview');
    const selectedFilesList = document.getElementById('selectedFilesList');
    
    // Opciones avanzadas de renombrado
    const renamePattern = document.getElementById('renamePattern');
    const lowercaseNames = document.getElementById('lowercaseNames');
    const removeSpaces = document.getElementById('removeSpaces');
    const sequentialNumbers = document.getElementById('sequentialNumbers');
    
    // Filtros de tipo de archivo
    const filterJpg = document.getElementById('filterJpg');
    const filterPng = document.getElementById('filterPng');
    const filterGif = document.getElementById('filterGif');
    const filterBmp = document.getElementById('filterBmp');
    const filterWebp = document.getElementById('filterWebp');
    const filterOther = document.getElementById('filterOther');
    const fileTypeSettings = document.getElementById('fileTypeSettings');

    // Event Listeners para renombrado
    selectFolderBtn.addEventListener('click', selectFolder);
    generateTemplateBtn.addEventListener('click', generateTemplate);
    uploadExcelBtn.addEventListener('click', () => excelFileInput.click());
    excelFileInput.addEventListener('change', handleExcelUpload);
    processBtn.addEventListener('click', processFiles);
    
    // Navegación para renombrado
    nextStep1.addEventListener('click', () => goToStep(2));
    nextStep2.addEventListener('click', () => goToStep(3));
    backStep2.addEventListener('click', () => goToStep(1));
    backStep3.addEventListener('click', () => goToStep(2));
    nextStep3.addEventListener('click', () => goToStep(4));
    backStep4.addEventListener('click', () => goToStep(3));
    
    // Opciones de renombrado
    renameAll.addEventListener('change', () => {
        selectFilesSection.style.display = 'none';
        selectedFilesToRename = [];
    });
    renameSelected.addEventListener('change', () => {
        selectFilesSection.style.display = 'block';
    });
    uploadFileList.addEventListener('click', () => fileListInput.click());
    fileListInput.addEventListener('change', handleFileListUpload);
    
    // Filtros de tipo de archivo
    filterJpg.addEventListener('change', updateFileFilters);
    filterPng.addEventListener('change', updateFileFilters);
    filterGif.addEventListener('change', updateFileFilters);
    filterBmp.addEventListener('change', updateFileFilters);
    filterWebp.addEventListener('change', updateFileFilters);
    filterOther.addEventListener('change', updateFileFilters);

    // Actualizar filtros de tipo de archivo
    function updateFileFilters() {
        fileTypeFilters = {
            jpg: filterJpg.checked,
            png: filterPng.checked,
            gif: filterGig.checked,
            bmp: filterBmp.checked,
            webp: filterWebp.checked,
            other: filterOther.checked
        };
        
        if (folderHandle) {
            filterAndShowFiles();
        }
    }

    // 1. Seleccionar carpeta para renombrado
    async function selectFolder() {
        try {
            // Resetear estado anterior
            resetState();
            
            // Usar la API de selección de directorios
            folderHandle = await window.showDirectoryPicker();
            
            // Obtener archivos de imagen
            imageFiles = await getImageFiles(folderHandle);
            
            // Mostrar información
            showFolderInfo();
            filterAndShowFiles();
            
            // Habilitar siguiente paso si hay archivos
            nextStep1.disabled = imageFiles.length === 0;
            
        } catch (error) {
            console.error("Error al seleccionar carpeta:", error);
            if (error.name !== 'AbortError') {
                showError("Error al seleccionar carpeta", error.message);
            }
        }
    }

    // Filtrar y mostrar archivos según los filtros
    async function filterAndShowFiles() {
        const filteredFiles = imageFiles.filter(file => {
            const ext = file.extension.toLowerCase().replace('.', '');
            const isImage = isImageExtension(file.extension);
            
            if (fileTypeFilters[ext]) return true;
            if (!isImage && fileTypeFilters.other) return true;
            return false;
        });
        
        showFilePreview(filteredFiles);
        
        // Actualizar contador
        fileCount.textContent = filteredFiles.length;
        
        // Calcular tamaño total
        let totalSizeBytes = 0;
        for (const file of filteredFiles) {
            const fileHandle = await file.handle.getFile();
            totalSizeBytes += fileHandle.size;
        }
        
        const totalSizeMB = (totalSizeBytes / (1024 * 1024)).toFixed(2);
        totalSize.textContent = `${totalSizeMB} MB`;
        
        // Mostrar u ocultar elementos según si hay archivos
        const hasFiles = filteredFiles.length > 0;
        folderInfo.style.display = hasFiles ? 'block' : 'none';
        fileListContainer.style.display = hasFiles ? 'block' : 'none';
        fileTypeSettings.style.display = hasFiles ? 'block' : 'none';
        nextStep1.disabled = !hasFiles;
    }

    // Resetear el estado de la aplicación
    function resetState() {
        imageFiles = [];
        folderHandle = null;
        excelData = [];
        selectedFilesToRename = [];
        fileList.innerHTML = '<p>No se han cargado archivos aún.</p>';
        excelPreview.style.display = 'none';
        excelPreviewContent.innerHTML = '';
        excelValidation.innerHTML = '';
        resultDiv.innerHTML = '';
        progressBar.style.width = '0%';
        progressText.textContent = '0% completado';
        progressContainer.style.display = 'none';
        processSummary.style.display = 'none';
        folderInfo.style.display = 'none';
        fileListContainer.style.display = 'none';
        fileTypeSettings.style.display = 'none';
        processBtn.disabled = true;
        nextStep3.disabled = true;
        renameAll.checked = true;
        selectFilesSection.style.display = 'none';
        fileListPreview.style.display = 'none';
        renamePattern.value = '';
    }

    // Obtener imágenes recursivamente
    async function getImageFiles(dirHandle, path = '') {
        const files = [];
        
        for await (const entry of dirHandle.values()) {
            const entryPath = path ? `${path}/${entry.name}` : entry.name;
            
            if (entry.kind === 'file') {
                const fileName = entry.name;
                const lastDotIndex = fileName.lastIndexOf('.');
                
                if (lastDotIndex === -1) {
                    // Archivo sin extensión
                    files.push({
                        name: fileName,
                        handle: entry,
                        extension: '',
                        path: path
                    });
                    continue;
                }
                
                const extension = fileName.slice(lastDotIndex);
                
                files.push({
                    name: fileName,
                    handle: entry,
                    extension: extension,
                    path: path
                });
            } else if (entry.kind === 'directory') {
                const subFiles = await getImageFiles(entry, entryPath);
                files.push(...subFiles);
            }
        }
        
        return files;
    }

    // Verificar si la extensión es de imagen
    function isImageExtension(ext) {
        const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
        return imageExtensions.includes(ext.toLowerCase());
    }

    // Mostrar información de la carpeta
    function showFolderInfo() {
        folderName.textContent = folderHandle.name;
        folderInfo.style.display = 'block';
    }

    // Mostrar vista previa de archivos
    function showFilePreview(files) {
        if (!files || files.length === 0) {
            fileList.innerHTML = '<p>No se encontraron archivos con los filtros actuales.</p>';
            return;
        }
        
        let html = '';
        files.slice(0, 100).forEach(file => {
            const icon = getFileIcon(file.extension);
            html += `
                <div class="file-item">
                    <div>
                        <i class="fas ${icon} file-icon"></i>
                        ${file.path ? `<span style="color: #6c757d;">${file.path}/</span>` : ''}
                        ${file.name}
                    </div>
                    <small style="color: #6c757d;">${file.extension ? file.extension.toUpperCase() : 'SIN EXT'}</small>
                </div>
            `;
        });
        
        if (files.length > 100) {
            html += `<div class="file-item">... y ${files.length - 100} archivos más</div>`;
        }
        
        fileList.innerHTML = html;
        fileListContainer.style.display = 'block';
    }

    // Obtener icono según extensión
    function getFileIcon(extension) {
        const ext = extension.toLowerCase();
        if (ext === '.jpg' || ext === '.jpeg') return 'fa-file-image';
        if (ext === '.png') return 'fa-file-image';
        if (ext === '.gif') return 'fa-file-image';
        if (ext === '.bmp') return 'fa-file-image';
        if (ext === '.webp') return 'fa-file-image';
        return 'fa-file';
    }

    // Manejar subida de lista de archivos
    function handleFileListUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                if (file.name.endsWith('.csv') || file.name.endsWith('.txt')) {
                    // Procesar CSV o TXT
                    Papa.parse(e.target.result, {
                        header: false,
                        complete: function(results) {
                            selectedFilesToRename = results.data
                                .flat()
                                .map(name => name.trim())
                                .filter(name => name !== '');
                            showSelectedFilesPreview();
                        }
                    });
                } else {
                    // Procesar Excel
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    selectedFilesToRename = jsonData
                        .flat()
                        .map(name => name && name.toString().trim())
                        .filter(name => name && name !== '');
                    showSelectedFilesPreview();
                }
            } catch (error) {
                console.error("Error al procesar archivo:", error);
                showError("Error al procesar archivo", "El archivo no es válido. Usa un Excel, CSV o TXT con una lista de nombres de archivo.");
            }
        };
        reader.onerror = function() {
            showError("Error de lectura", "No se pudo leer el archivo. Por favor, inténtalo de nuevo.");
        };
        
        if (file.name.endsWith('.csv') || file.name.endsWith('.txt')) {
            reader.readAsText(file);
        } else {
            reader.readAsArrayBuffer(file);
        }
    }

    // Mostrar vista previa de archivos seleccionados
    function showSelectedFilesPreview() {
        if (selectedFilesToRename.length === 0) {
            selectedFilesList.innerHTML = '<p>No se encontraron nombres válidos en el archivo.</p>';
            fileListPreview.style.display = 'block';
            return;
        }
        
        let html = '';
        selectedFilesToRename.slice(0, 50).forEach(fileName => {
            html += `<div class="preview-item">${fileName}</div>`;
        });
        
        if (selectedFilesToRename.length > 50) {
            html += `<div class="preview-item">... y ${selectedFilesToRename.length - 50} más</div>`;
        }
        
        selectedFilesList.innerHTML = html;
        fileListPreview.style.display = 'block';
    }

    // 2. Generar plantilla Excel para renombrado
    function generateTemplate() {
        // Filtrar archivos según los filtros activos
        let filteredFiles = imageFiles.filter(file => {
            const ext = file.extension.toLowerCase().replace('.', '');
            const isImage = isImageExtension(file.extension);
            
            if (fileTypeFilters[ext]) return true;
            if (!isImage && fileTypeFilters.other) return true;
            return false;
        });
        
        // Si estamos en modo "seleccionar archivos", filtrar solo esos
        if (renameSelected.checked && selectedFilesToRename.length > 0) {
            filteredFiles = filteredFiles.filter(file => {
                const fileNameWithoutExt = file.name.substring(0, file.name.lastIndexOf('.'));
                return selectedFilesToRename.includes(fileNameWithoutExt);
            });
        }
        
        // Aplicar patrón de renombrado si está configurado
        const pattern = renamePattern.value.trim();
        let counter = 1;
        
        excelData = filteredFiles.map(file => {
            const originalName = file.name;
            const extension = file.extension;
            const nameWithoutExt = originalName.substring(0, originalName.lastIndexOf('.'));
            
            let newName = '';
            
            if (pattern) {
                // Aplicar patrón de renombrado
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-');
                
                newName = pattern
                    .replace(/{n}/g, counter++)
                    .replace(/{name}/g, nameWithoutExt)
                    .replace(/{date}/g, dateStr)
                    .replace(/{time}/g, timeStr);
                
                // Aplicar transformaciones adicionales
                if (lowercaseNames.checked) {
                    newName = newName.toLowerCase();
                }
                if (removeSpaces.checked) {
                    newName = newName.replace(/\s+/g, '-');
                }
            }
            
            return {
                nombreOriginal: file.name, // Solo el nombre del archivo, sin ruta
                nuevoNombre: newName,
                extension: extension,
                rutaOriginal: file.path || ''
            };
        });
        
        // Crear hoja de datos
        const ws = XLSX.utils.json_to_sheet(excelData);
        
        // Establecer ancho de columnas
        ws['!cols'] = [
            { wch: 30 }, // nombreOriginal
            { wch: 30 }, // nuevoNombre
            { wch: 10 }, // extension
            { wch: 30 }  // rutaOriginal
        ];
        
        // Crear libro de Excel
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Archivos");
        
        // Añadir hoja de instrucciones
        const instructions = [
            ["INSTRUCCIONES PARA RENOMBRAR ARCHIVOS"],
            [],
            ["1. Edita SOLO la columna 'nuevoNombre'"],
            ["2. No incluyas la extensión del archivo (se agregará automáticamente)"],
            ["3. Deja vacío si no deseas cambiar ese archivo"],
            ["4. Caracteres no permitidos: \\ / : * ? \" < > |"],
            ["5. Para mantener estructura de carpetas, incluye la ruta en el nuevo nombre"],
            ["   Ejemplo: 'nuevas/subcarpeta/mi_archivo'"],
            ["6. Si hay nombres duplicados, se agregará un sufijo numérico"],
            [],
            ["COLUMNAS:"],
            ["- nombreOriginal: Nombre original del archivo (NO MODIFICAR)"],
            ["- nuevoNombre: Nuevo nombre (sin extensión)"],
            ["- extension: Extensión del archivo (NO MODIFICAR)"],
            ["- rutaOriginal: Ruta relativa del archivo (NO MODIFICAR)"]
        ];
        
        const instructionWs = XLSX.utils.aoa_to_sheet(instructions);
        
        // Ajustar anchos para hoja de instrucciones
        instructionWs['!cols'] = [{ wch: 100 }];
        
        XLSX.utils.book_append_sheet(wb, instructionWs, "Instrucciones");
        
        // Generar nombre de archivo con fecha
        const date = new Date();
        const dateStr = `${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}`;
        const timeStr = `${date.getHours().toString().padStart(2, '0')}${date.getMinutes().toString().padStart(2, '0')}`;
        
        XLSX.writeFile(wb, `plantilla_renombrado_${dateStr}_${timeStr}.xlsx`);
    }

    // 3. Manejar Excel subido para renombrado
    function handleExcelUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                excelData = XLSX.utils.sheet_to_json(firstSheet);
                
                // Validar formato básico
                if (!excelData[0]?.nombreOriginal) {
                    showError("Formato incorrecto", "El archivo Excel no tiene el formato esperado. Asegúrate de que contiene al menos la columna 'nombreOriginal'.");
                    nextStep3.disabled = true;
                    return;
                }
                
                // Asegurar que exista columna nuevoNombre
                if (!excelData[0].hasOwnProperty('nuevoNombre')) {
                    excelData = excelData.map(item => ({ 
                        ...item, 
                        nuevoNombre: '',
                        extension: item.nombreOriginal.split('.').pop() || ''
                    }));
                }
                
                // Procesar extensiones si no están en los datos
                excelData = excelData.map(item => {
                    if (!item.extension) {
                        const parts = item.nombreOriginal.split('.');
                        return {
                            ...item,
                            extension: parts.length > 1 ? `.${parts.pop()}` : ''
                        };
                    }
                    // Asegurar que la extensión empiece con punto
                    if (item.extension && !item.extension.startsWith('.')) {
                        return {
                            ...item,
                            extension: `.${item.extension}`
                        };
                    }
                    return item;
                });
                
                // Mostrar vista previa y validaciones
                showExcelPreview();
                validateExcelData();
                
            } catch (error) {
                console.error("Error al procesar Excel:", error);
                showError("Error al procesar Excel", "El archivo no es un Excel válido o está corrupto. Por favor, usa el archivo generado por esta herramienta.");
                nextStep3.disabled = true;
            }
        };
        reader.onerror = function() {
            showError("Error de lectura", "No se pudo leer el archivo Excel. Por favor, inténtalo de nuevo.");
            nextStep3.disabled = true;
        };
        reader.readAsArrayBuffer(file);
    }

    // Mostrar vista previa del Excel
    function showExcelPreview() {
        const changes = excelData.filter(item => item.nuevoNombre && item.nuevoNombre.trim() !== '');
        
        let html = '';
        changes.slice(0, 50).forEach(item => {
            const extension = keepOriginalExt.checked ? (item.extension || '') : '';
            const newName = item.nuevoNombre.endsWith(extension) 
                ? item.nuevoNombre 
                : `${item.nuevoNombre}${extension}`;
            
            html += `<div class="preview-item">
                <span style="color: #6c757d;">${item.nombreOriginal}</span> 
                → 
                <strong style="color: var(--primary);">${newName}</strong>
            </div>`;
        });
        
        if (changes.length > 50) {
            html += `<div class="preview-item">... y ${changes.length - 50} cambios más</div>`;
        }
        
        excelPreviewContent.innerHTML = html;
        excelPreview.style.display = 'block';
    }

    // Validar datos del Excel
    function validateExcelData() {
        const changes = excelData.filter(item => item.nuevoNombre && item.nuevoNombre.trim() !== '');
        
        if (changes.length === 0) {
            excelValidation.innerHTML = `
                <div class="alert-box alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <strong>Advertencia:</strong> No hay nombres nuevos asignados en el Excel. 
                        Todos los archivos mantendrán sus nombres originales.
                    </div>
                </div>
            `;
            nextStep3.disabled = false;
            return;
        }
        
        // Verificar nombres inválidos
        const invalidChars = /[\\/:*?"<>|]/;
        const invalidNames = changes.filter(item => invalidChars.test(item.nuevoNombre));
        
        // Verificar nombres duplicados
        const newNames = changes.map(item => {
            const ext = keepOriginalExt.checked ? (item.extension || '') : '';
            return item.nuevoNombre.endsWith(ext) 
                ? item.nuevoNombre 
                : `${item.nuevoNombre}${ext}`;
        });
        
        const duplicates = findDuplicates(newNames);
        
        // Verificar archivos no encontrados si está activada la coincidencia estricta
        let unmatchedFiles = [];
        if (strictMatching.checked) {
            unmatchedFiles = changes.filter(item => {
                return !imageFiles.some(file => file.name === item.nombreOriginal);
            });
        }
        
        // Mostrar validaciones
        let validationHtml = '';
        
        if (invalidNames.length > 0) {
            validationHtml += `
                <div class="alert-box alert-error">
                    <i class="fas fa-exclamation-circle"></i>
                    <div>
                        <strong>Error:</strong> ${invalidNames.length} nombres contienen caracteres inválidos (\\ / : * ? " < > |).
                        <div style="margin-top: 0.5rem; font-size: 0.9rem;">
                            ${invalidNames.slice(0, 3).map(item => `"${item.nuevoNombre}"`).join(', ')}
                            ${invalidNames.length > 3 ? `... y ${invalidNames.length - 3} más` : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        if (duplicates.length > 0) {
            validationHtml += `
                <div class="alert-box alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <strong>Advertencia:</strong> Hay ${duplicates.length} nombres duplicados.
                        <div style="margin-top: 0.5rem; font-size: 0.9rem;">
                            ${duplicates.slice(0, 3).join(', ')}
                            ${duplicates.length > 3 ? `... y ${duplicates.length - 3} más` : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        if (unmatchedFiles.length > 0) {
            validationHtml += `
                <div class="alert-box alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <strong>Advertencia:</strong> ${unmatchedFiles.length} archivos del Excel no coinciden con los archivos originales.
                        <div style="margin-top: 0.5rem; font-size: 0.9rem;">
                            ${unmatchedFiles.slice(0, 3).map(item => `"${item.nombreOriginal}"`).join(', ')}
                            ${unmatchedFiles.length > 3 ? `... y ${unmatchedFiles.length - 3} más` : ''}
                        </div>
                        <div style="margin-top: 0.5rem;">
                            <small>Desactiva "Coincidencia exacta" si quieres procesar estos archivos de todos modos.</small>
                        </div>
                    </div>
                </div>
            `;
        }
        
        if (invalidNames.length === 0 && duplicates.length === 0 && unmatchedFiles.length === 0) {
            validationHtml += `
                <div class="alert-box alert-success">
                    <i class="fas fa-check-circle"></i>
                    <div>
                        <strong>Excel válido:</strong> Todos los nombres son correctos y no hay duplicados.
                    </div>
                </div>
            `;
        }
        
        excelValidation.innerHTML = validationHtml;
        
        // Habilitar siguiente paso si no hay errores críticos
        nextStep3.disabled = invalidNames.length > 0 || (strictMatching.checked && unmatchedFiles.length > 0);
        
        // Actualizar resumen para el paso 4
        updateProcessSummary();
    }

    // Actualizar resumen de procesamiento
    function updateProcessSummary() {
        const changes = excelData.filter(item => item.nuevoNombre && item.nuevoNombre.trim() !== '');
        const noChanges = excelData.length - changes.length;
        
        // Verificar nombres duplicados
        const newNames = changes.map(item => {
            const ext = keepOriginalExt.checked ? (item.extension || '') : '';
            return item.nuevoNombre.endsWith(ext) 
                ? item.nuevoNombre 
                : `${item.nuevoNombre}${ext}`;
        });
        
        const duplicates = findDuplicates(newNames);
        
        filesToRename.textContent = changes.length;
        filesUnchanged.textContent = noChanges;
        duplicateNames.textContent = duplicates.length;
        
        processSummary.style.display = 'block';
        processBtn.disabled = changes.length === 0;
    }

    // 4. Procesar archivos para renombrado
    async function processFiles() {
        if (!excelData.length) {
            showError("Error", "No hay datos para procesar");
            return;
        }
        
        const changes = excelData.filter(item => item.nuevoNombre && item.nuevoNombre.trim() !== '');
        
        if (changes.length === 0) {
            showError("Error", "No hay nombres nuevos asignados en el Excel. No hay cambios que procesar.");
            return;
        }
        
        // Validar nombres inválidos
        const invalidChars = /[\\/:*?"<>|]/;
        const invalidNames = changes.filter(item => invalidChars.test(item.nuevoNombre));
        
        if (invalidNames.length > 0) {
            showError("Nombres inválidos", `${invalidNames.length} nombres contienen caracteres no permitidos (\\ / : * ? " < > |).`);
            return;
        }
        
        // Verificar duplicados
        const newNames = changes.map(item => {
            const ext = keepOriginalExt.checked ? (item.extension || '') : '';
            return item.nuevoNombre.endsWith(ext) 
                ? item.nuevoNombre 
                : `${item.nuevoNombre}${ext}`;
        });
        
        const duplicates = findDuplicates(newNames);
        if (duplicates.length > 0) {
            showError("Nombres duplicados", `Hay ${duplicates.length} nombres duplicados. Por favor, corrige estos nombres antes de continuar.`);
            return;
        }
        
        // Verificar archivos no encontrados si está activada la coincidencia estricta
        if (strictMatching.checked) {
            const unmatchedFiles = changes.filter(item => {
                return !imageFiles.some(file => file.name === item.nombreOriginal);
            });
            
            if (unmatchedFiles.length > 0) {
                showError("Archivos no encontrados", `${unmatchedFiles.length} archivos del Excel no coinciden con los archivos originales. Desactiva "Coincidencia exacta" si quieres continuar de todos modos.`);
                return;
            }
        }
        
        try {
            processBtn.disabled = true;
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            progressText.textContent = '0% completado';
            
            const zip = new JSZip();
            let processed = 0;
            let skipped = 0;
            let renamed = 0;
            const errors = [];
            const nameCount = {};
            
            // Crear ZIP de backup si está habilitado
            let backupZip = createBackup.checked ? new JSZip() : null;
            
            // Procesar solo los archivos con cambios
            for (const item of changes) {
                try {
                    // Encontrar el archivo original
                    let originalFile;
                    
                    if (strictMatching.checked) {
                        // Coincidencia exacta por nombre
                        originalFile = imageFiles.find(file => file.name === item.nombreOriginal);
                    } else {
                        // Coincidencia por nombre de archivo (sin ruta)
                        const fileName = item.nombreOriginal;
                        originalFile = imageFiles.find(file => file.name === fileName);
                    }
                    
                    if (!originalFile) {
                        skipped++;
                        errors.push(`No se encontró el archivo original: ${item.nombreOriginal}`);
                        continue;
                    }
                    
                    const file = await originalFile.handle.getFile();
                    const extension = keepOriginalExt.checked ? (item.extension || originalFile.extension || '') : '';
                    
                    // Generar nombre final
                    let finalName = item.nuevoNombre.trim();
                    
                    // Asegurar que tenga la extensión correcta
                    if (extension && !finalName.toLowerCase().endsWith(extension.toLowerCase())) {
                        finalName += extension;
                    }
                    
                    // Manejar duplicados en tiempo real (por si acaso)
                    if (nameCount[finalName]) {
                        nameCount[finalName]++;
                        const baseName = finalName.substring(0, finalName.lastIndexOf('.'));
                        const ext = finalName.substring(finalName.lastIndexOf('.'));
                        finalName = `${baseName}_${nameCount[finalName]}${ext}`;
                    } else {
                        nameCount[finalName] = 1;
                    }
                    
                    // Agregar al ZIP según configuración
                    if (createZip.checked) {
                        if (preserveOriginal.checked && item.rutaOriginal) {
                            // Mantener estructura de carpetas original
                            const pathParts = item.rutaOriginal.split('/');
                            let currentFolder = zip;
                            
                            // Crear estructura de carpetas
                            for (const folder of pathParts) {
                                if (!currentFolder.folder(folder)) {
                                    currentFolder = currentFolder.folder(folder);
                                }
                            }
                            
                            // Agregar archivo
                            currentFolder.file(finalName, file);
                        } else {
                            // Agregar todos los archivos en la raíz
                            zip.file(finalName, file);
                        }
                    }
                    
                    // Agregar a backup si está habilitado
                    if (backupZip) {
                        if (item.rutaOriginal) {
                            const pathParts = item.rutaOriginal.split('/');
                            let currentFolder = backupZip;
                            
                            for (const folder of pathParts) {
                                if (!currentFolder.folder(folder)) {
                                    currentFolder = currentFolder.folder(folder);
                                }
                            }
                            
                            currentFolder.file(originalFile.name, file);
                        } else {
                            backupZip.file(originalFile.name, file);
                        }
                    }
                    
                    renamed++;
                    processed++;
                    
                    // Actualizar progreso
                    const progress = (processed / changes.length) * 100;
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `${progress.toFixed(1)}% completado (${renamed} renombrados)`;
                    
                } catch (error) {
                    console.error(`Error al procesar ${item.nombreOriginal}:`, error);
                    errors.push(`Error al procesar ${item.nombreOriginal}: ${error.message}`);
                    skipped++;
                }
            }
            
            // Incluir archivos sin cambios si está marcada la opción
            if (includeUnchanged.checked && createZip.checked) {
                const unchangedFiles = excelData.filter(item => !item.nuevoNombre || item.nuevoNombre.trim() === '');
                
                for (const item of unchangedFiles) {
                    try {
                        let originalFile;
                        
                        if (strictMatching.checked) {
                            // Coincidencia exacta por nombre
                            originalFile = imageFiles.find(file => file.name === item.nombreOriginal);
                        } else {
                            // Coincidencia por nombre de archivo (sin ruta)
                            const fileName = item.nombreOriginal;
                            originalFile = imageFiles.find(file => file.name === fileName);
                        }
                        
                        if (!originalFile) {
                            skipped++;
                            errors.push(`No se encontró el archivo original: ${item.nombreOriginal}`);
                            continue;
                        }
                        
                        const file = await originalFile.handle.getFile();
                        
                        if (preserveOriginal.checked && item.rutaOriginal) {
                            // Mantener estructura de carpetas original
                            const pathParts = item.rutaOriginal.split('/');
                            let currentFolder = zip;
                            
                            // Crear estructura de carpetas
                            for (const folder of pathParts) {
                                if (!currentFolder.folder(folder)) {
                                    currentFolder = currentFolder.folder(folder);
                                }
                            }
                            
                            // Agregar archivo
                            currentFolder.file(originalFile.name, file);
                        } else {
                            // Agregar todos los archivos en la raíz
                            zip.file(originalFile.name, file);
                        }
                        
                        processed++;
                        
                        // Actualizar progreso
                        const progress = (processed / (changes.length + unchangedFiles.length)) * 100;
                        progressBar.style.width = `${progress}%`;
                        progressText.textContent = `${progress.toFixed(1)}% completado (${renamed} renombrados, ${processed - renamed} sin cambios)`;
                        
                    } catch (error) {
                        console.error(`Error al procesar ${item.nombreOriginal}:`, error);
                        errors.push(`Error al procesar ${item.nombreOriginal}: ${error.message}`);
                        skipped++;
                    }
                }
            }
            
            // Mostrar resultado
            let resultMessage = `
                <div class="alert-box alert-success">
                    <i class="fas fa-check-circle"></i>
                    <div>
                        <strong>¡Proceso completado!</strong>
                        <div style="margin-top: 0.5rem;">
                            <div>Archivos renombrados: ${renamed}</div>
                            ${skipped > 0 ? `<div>Archivos no procesados: ${skipped}</div>` : ''}
                            ${includeUnchanged.checked ? `<div>Archivos sin cambios incluidos: ${processed - renamed}</div>` : ''}
                        </div>
            `;
            
            if (createZip.checked) {
                if (renamed > 0 || (includeUnchanged.checked && processed > 0)) {
                    // Generar ZIP
                    const content = await zip.generateAsync({ type: 'blob', compression: "DEFLATE" }, metadata => {
                        const progress = metadata.percent.toFixed(1);
                        progressText.textContent = `${progress}% completado (creando ZIP)`;
                    });
                    
                    // Descargar ZIP
                    const date = new Date();
                    const dateStr = `${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}`;
                    const timeStr = `${date.getHours().toString().padStart(2, '0')}${date.getMinutes().toString().padStart(2, '0')}`;
                    
                    saveAs(content, `archivos_renombrados_${dateStr}_${timeStr}.zip`);
                    
                    resultMessage += `
                        <div style="margin-top: 0.5rem;">
                            Se ha creado un archivo ZIP con ${renamed} archivos renombrados${includeUnchanged.checked ? ` y ${processed - renamed} archivos sin cambios` : ''}.
                        </div>
                    `;
                } else {
                    resultMessage += `
                        <div style="margin-top: 0.5rem;">
                            No se creó archivo ZIP porque no hubo archivos para incluir.
                        </div>
                    `;
                }
            }
            
            // Crear backup si está habilitado
            if (backupZip) {
                const backupContent = await backupZip.generateAsync({ type: 'blob', compression: "DEFLATE" });
                const date = new Date();
                const dateStr = `${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}`;
                const timeStr = `${date.getHours().toString().padStart(2, '0')}${date.getMinutes().toString().padStart(2, '0')}`;
                
                saveAs(backupContent, `backup_original_${dateStr}_${timeStr}.zip`);
                
                resultMessage += `
                    <div style="margin-top: 0.5rem;">
                        Se ha creado un archivo ZIP de backup con los archivos originales.
                    </div>
                `;
            }
            
            resultMessage += `</div></div>`;
            
            if (errors.length > 0) {
                resultMessage += `
                    <div class="alert-box alert-warning" style="margin-top: 1rem;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <strong>Errores encontrados (${errors.length}):</strong>
                            <div style="margin-top: 0.5rem; max-height: 150px; overflow-y: auto; font-size: 0.9rem;">
                                ${errors.slice(0, 5).map(e => `<div>• ${e}</div>`).join('')}
                                ${errors.length > 5 ? `<div>... y ${errors.length - 5} más</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            resultDiv.innerHTML = resultMessage;
            processBtn.disabled = false;
            
        } catch (error) {
            console.error("Error en el proceso:", error);
            showError("Error al procesar", error.message);
            processBtn.disabled = false;
        }
    }

    // Helper: Encontrar duplicados
    function findDuplicates(arr) {
        const seen = {};
        const duplicates = [];
        
        arr.forEach(item => {
            if (seen[item]) {
                if (seen[item] === 1) {
                    duplicates.push(item);
                }
                seen[item]++;
            } else {
                seen[item] = 1;
            }
        });
        
        return duplicates;
    }

    // Mostrar mensaje de error
    function showError(title, message) {
        resultDiv.innerHTML = `
            <div class="alert-box alert-error">
                <i class="fas fa-exclamation-circle"></i>
                <div>
                    <strong>${title}:</strong> ${message}
                </div>
            </div>
        `;
    }

    // Navegación entre pasos
    function goToStep(stepNumber) {
        steps.forEach((step, index) => {
            step.classList.toggle('active', index === stepNumber - 1);
        });
        
        // Desplazarse al inicio del paso
        const activeStep = document.querySelector('#rename-tab .step.active');
        if (activeStep) {
            activeStep.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }
</script>

<script>
    // Variables globales para compresión
    let compressFiles = [];
    let compressFolderHandle;
    
    // Elementos del DOM para compresión
    const selectFilesBtn = document.getElementById('selectFiles');
    const selectCompressFolderBtn = document.getElementById('selectCompressFolder');
    const compressFileInput = document.getElementById('compressFileInput');
    const compressProcessBtn = document.getElementById('compressProcess');
    const compressFileList = document.getElementById('compressFileList');
    const compressFolderInfo = document.getElementById('compressFolderInfo');
    const compressItemName = document.getElementById('compressItemName');
    const compressFileCount = document.getElementById('compressFileCount');
    const compressTotalSize = document.getElementById('compressTotalSize');
    const compressFileListContainer = document.getElementById('compressFileListContainer');
    const compressProgressBar = document.getElementById('compressProgress');
    const compressProgressText = document.getElementById('compressProgressText');
    const compressProgressContainer = document.getElementById('compressProgressContainer');
    const compressResult = document.getElementById('compressResult');
    const compressSteps = document.querySelectorAll('#compress-tab .step');
    const compressNextStep1 = document.getElementById('compressNextStep1');
    const compressBackStep2 = document.getElementById('compressBackStep2');
    
    // Opciones de compresión
    const compressPreservePaths = document.getElementById('compressPreservePaths');
    const compressIncludeHidden = document.getElementById('compressIncludeHidden');
    const compressFilename = document.getElementById('compressFilename');
    const compressLevel = document.getElementById('compressLevel');
    const compressSplitFiles = document.getElementById('compressSplitFiles');
    const compressSplitSize = document.getElementById('compressSplitSize');

    // Event Listeners para compresión
    selectFilesBtn.addEventListener('click', () => compressFileInput.click());
    selectCompressFolderBtn.addEventListener('click', selectCompressFolder);
    compressFileInput.addEventListener('change', handleCompressFileSelect);
    compressProcessBtn.addEventListener('click', compressSelectedFiles);
    compressSplitFiles.addEventListener('change', () => {
        compressSplitSize.disabled = !compressSplitFiles.checked;
    });
    
    // Navegación para compresión
    compressNextStep1.addEventListener('click', () => goToCompressStep(2));
    compressBackStep2.addEventListener('click', () => goToCompressStep(1));

    // 1. Seleccionar archivos para compresión
    function handleCompressFileSelect(event) {
        const files = Array.from(event.target.files);
        if (files.length === 0) return;
        
        // Resetear estado anterior
        resetCompressState();
        
        // Procesar archivos seleccionados
        compressFiles = files.map(file => ({
            name: file.name,
            file: file,
            path: ''
        }));
        
        // Mostrar información
        showCompressInfo(files.length > 1 ? `${files.length} archivos seleccionados` : files[0].name, files);
        
        // Habilitar siguiente paso
        compressNextStep1.disabled = false;
    }

    // 1. Seleccionar carpeta para compresión
    async function selectCompressFolder() {
        try {
            // Resetear estado anterior
            resetCompressState();
            
            // Usar la API de selección de directorios
            compressFolderHandle = await window.showDirectoryPicker();
            
            // Obtener todos los archivos recursivamente
            compressFiles = await getAllFiles(compressFolderHandle);
            
            // Mostrar información
            showCompressInfo(compressFolderHandle.name, compressFiles);
            
            // Habilitar siguiente paso
            compressNextStep1.disabled = compressFiles.length === 0;
            
        } catch (error) {
            console.error("Error al seleccionar carpeta:", error);
            if (error.name !== 'AbortError') {
                showCompressError("Error al seleccionar carpeta", error.message);
            }
        }
    }

    // Obtener todos los archivos recursivamente
    async function getAllFiles(dirHandle, path = '') {
        const files = [];
        
        for await (const entry of dirHandle.values()) {
            const entryPath = path ? `${path}/${entry.name}` : entry.name;
            
            if (entry.kind === 'file') {
                files.push({
                    name: entry.name,
                    handle: entry,
                    path: path
                });
            } else if (entry.kind === 'directory') {
                const subFiles = await getAllFiles(entry, entryPath);
                files.push(...subFiles);
            }
        }
        
        return files;
    }

    // Mostrar información de archivos/carpeta para compresión
    async function showCompressInfo(name, files) {
        compressItemName.textContent = name;
        
        // Calcular tamaño total
        let totalSizeBytes = 0;
        
        if (files[0].file) {
            // Archivos seleccionados directamente
            compressFileCount.textContent = files.length;
            
            for (const file of files) {
                totalSizeBytes += file.file.size;
            }
        } else {
            // Archivos de carpeta
            compressFileCount.textContent = files.length;
            
            for (const file of files) {
                const fileHandle = await file.handle.getFile();
                totalSizeBytes += fileHandle.size;
            }
        }
        
        const totalSizeMB = (totalSizeBytes / (1024 * 1024)).toFixed(2);
        compressTotalSize.textContent = `${totalSizeMB} MB`;
        
        // Mostrar vista previa
        showCompressFilePreview(files.slice(0, 100));
        
        // Mostrar elementos
        compressFolderInfo.style.display = 'block';
        compressFileListContainer.style.display = 'block';
    }

    // Mostrar vista previa de archivos para compresión
    function showCompressFilePreview(files) {
        if (!files || files.length === 0) {
            compressFileList.innerHTML = '<p>No se encontraron archivos.</p>';
            return;
        }
        
        let html = '';
        files.forEach(file => {
            const icon = getFileIcon(file.name.split('.').pop() || '');
            html += `
                <div class="file-item">
                    <div>
                        <i class="fas ${icon} file-icon"></i>
                        ${file.path ? `<span style="color: #6c757d;">${file.path}/</span>` : ''}
                        ${file.name || file.file.name}
                    </div>
                    <small style="color: #6c757d;">${(file.name || file.file.name).split('.').pop().toUpperCase()}</small>
                </div>
            `;
        });
        
        if (compressFiles.length > 100) {
            html += `<div class="file-item">... y ${compressFiles.length - 100} archivos más</div>`;
        }
        
        compressFileList.innerHTML = html;
    }

    // Resetear el estado de compresión
    function resetCompressState() {
        compressFiles = [];
        compressFolderHandle = null;
        compressFileList.innerHTML = '<p>No se han seleccionado archivos aún.</p>';
        compressFolderInfo.style.display = 'none';
        compressFileListContainer.style.display = 'none';
        compressResult.innerHTML = '';
        compressProgressBar.style.width = '0%';
        compressProgressText.textContent = '0% completado';
        compressProgressContainer.style.display = 'none';
        compressNextStep1.disabled = true;
    }

    // 2. Comprimir archivos seleccionados
    async function compressSelectedFiles() {
        if (compressFiles.length === 0) {
            showCompressError("Error", "No hay archivos seleccionados para comprimir.");
            return;
        }
        
        try {
            compressProcessBtn.disabled = true;
            compressProgressContainer.style.display = 'block';
            compressProgressBar.style.width = '0%';
            compressProgressText.textContent = '0% completado';
            
            const zip = new JSZip();
            let processed = 0;
            const errors = [];
            
            // Configuración de compresión
            const options = {
                level: parseInt(compressLevel.value),
                compression: "DEFLATE"
            };
            
            // Procesar archivos
            for (const file of compressFiles) {
                try {
                    let fileData, fileName, filePath;
                    
                    if (file.file) {
                        // Archivo seleccionado directamente
                        fileData = file.file;
                        fileName = file.name;
                        filePath = file.path;
                    } else {
                        // Archivo de carpeta
                        const fileHandle = await file.handle.getFile();
                        fileData = fileHandle;
                        fileName = file.name;
                        filePath = file.path;
                    }
                    
                    // Agregar al ZIP según configuración
                    if (compressPreservePaths.checked && filePath) {
                        // Mantener estructura de carpetas
                        const pathParts = filePath.split('/');
                        let currentFolder = zip;
                        
                        // Crear estructura de carpetas
                        for (const folder of pathParts) {
                            if (!currentFolder.folder(folder)) {
                                currentFolder = currentFolder.folder(folder);
                            }
                        }
                        
                        // Agregar archivo
                        currentFolder.file(fileName, fileData);
                    } else {
                        // Agregar todos los archivos en la raíz
                        zip.file(fileName, fileData);
                    }
                    
                    processed++;
                    
                    // Actualizar progreso
                    const progress = (processed / compressFiles.length) * 100;
                    compressProgressBar.style.width = `${progress}%`;
                    compressProgressText.textContent = `${progress.toFixed(1)}% completado (${processed}/${compressFiles.length})`;
                    
                } catch (error) {
                    console.error(`Error al procesar ${file.name || file.file.name}:`, error);
                    errors.push(`Error al procesar ${file.name || file.file.name}: ${error.message}`);
                }
            }
            
            // Generar nombre de archivo
            let filename = compressFilename.value.trim() || 'archivos_comprimidos';
            if (!filename.toLowerCase().endsWith('.zip')) {
                filename += '.zip';
            }
            
            // Opciones de generación
            const zipOptions = {
                type: 'blob',
                compression: "DEFLATE",
                compressionOptions: {
                    level: parseInt(compressLevel.value)
                }
            };
            
            // Dividir ZIP si está habilitado
            if (compressSplitFiles.checked) {
                const splitSize = parseInt(compressSplitSize.value) * 1024 * 1024; // Convertir a bytes
                zipOptions.maxSize = splitSize;
                zipOptions.split = true;
            }
            
            // Generar ZIP
            const content = await zip.generateAsync(zipOptions, metadata => {
                const progress = metadata.percent.toFixed(1);
                compressProgressText.textContent = `${progress}% completado (creando ZIP)`;
            });
            
            // Descargar ZIP
            saveAs(content, filename);
            
            // Mostrar resultado
            let resultMessage = `
                <div class="alert-box alert-success">
                    <i class="fas fa-check-circle"></i>
                    <div>
                        <strong>¡Compresión completada!</strong>
                        <div style="margin-top: 0.5rem;">
                            <div>Archivos comprimidos: ${processed}</div>
                            ${errors.length > 0 ? `<div>Archivos con errores: ${errors.length}</div>` : ''}
                            <div>Nombre del archivo: ${filename}</div>
                        </div>
            `;
            
            if (compressSplitFiles.checked) {
                resultMessage += `
                    <div style="margin-top: 0.5rem;">
                        El archivo ZIP ha sido dividido en partes de ${compressSplitSize.value} MB.
                    </div>
                `;
            }
            
            resultMessage += `</div></div>`;
            
            if (errors.length > 0) {
                resultMessage += `
                    <div class="alert-box alert-warning" style="margin-top: 1rem;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <strong>Errores encontrados (${errors.length}):</strong>
                            <div style="margin-top: 0.5rem; max-height: 150px; overflow-y: auto; font-size: 0.9rem;">
                                ${errors.slice(0, 5).map(e => `<div>• ${e}</div>`).join('')}
                                ${errors.length > 5 ? `<div>... y ${errors.length - 5} más</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            compressResult.innerHTML = resultMessage;
            compressProcessBtn.disabled = false;
            
        } catch (error) {
            console.error("Error en la compresión:", error);
            showCompressError("Error al comprimir", error.message);
            compressProcessBtn.disabled = false;
        }
    }

    // Mostrar mensaje de error en compresión
    function showCompressError(title, message) {
        compressResult.innerHTML = `
            <div class="alert-box alert-error">
                <i class="fas fa-exclamation-circle"></i>
                <div>
                    <strong>${title}:</strong> ${message}
                </div>
            </div>
        `;
    }

    // Navegación entre pasos de compresión
    function goToCompressStep(stepNumber) {
        compressSteps.forEach((step, index) => {
            step.classList.toggle('active', index === stepNumber - 1);
        });
        
        // Desplazarse al inicio del paso
        const activeStep = document.querySelector('#compress-tab .step.active');
        if (activeStep) {
            activeStep.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    // Manejar cambio de pestañas
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const tabId = btn.getAttribute('data-tab');
            
            // Actualizar botones de pestaña
            document.querySelectorAll('.tab-btn').forEach(tb => {
                tb.classList.toggle('active', tb === btn);
            });
            
            // Mostrar contenido de pestaña
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === tabId);
            });
            
            // Reiniciar pasos de la pestaña activa
            if (tabId === 'rename-tab') {
                goToStep(1);
            } else {
                goToCompressStep(1);
            }
        });
    });
</script>
</body>
</html>